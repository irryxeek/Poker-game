<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>德州扑克 Pro</title>
    <style>
        :root {
            --bg: #0a0c10;
            --bg-soft: #10141c;
            --surface: #141a24;
            --surface-2: #1a2230;
            --surface-3: #222c3c;
            --text: #e8eef6;
            --muted: #8a96a8;
            --accent: #4fc3f7;
            --accent-strong: #29b6f6;
            --accent-soft: rgba(79, 195, 247, 0.15);
            --success: #4caf50;
            --warning: #ffb74d;
            --danger: #ef5350;
            --danger-strong: #e53935;
            --gold: #ffd54f;
            --ink: #080a0e;
            --card-back: #1a2436;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
        }
        /* === 基础重置 === */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            line-height: 1.5;
        }

        /* === 登录页 === */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: radial-gradient(ellipse at center, #141a26 0%, #0a0c10 70%);
            position: relative;
            overflow: hidden;
        }
        #login-screen::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 30%, rgba(79, 195, 247, 0.05) 0%, transparent 50%),
                        radial-gradient(circle at 70% 70%, rgba(239, 83, 80, 0.03) 0%, transparent 50%);
            animation: bg-rotate 30s linear infinite;
        }
        @keyframes bg-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        #login-screen h1 {
            font-size: 48px;
            background: linear-gradient(135deg, #e8eef6 0%, #4fc3f7 50%, #e8eef6 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 48px;
            letter-spacing: 6px;
            font-weight: 700;
            text-shadow: 0 0 40px rgba(79, 195, 247, 0.3);
            animation: title-shine 3s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }
        @keyframes title-shine {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        #login-screen input {
            padding: 16px 28px;
            border-radius: var(--radius-xl);
            border: 2px solid rgba(79, 195, 247, 0.3);
            font-size: 17px;
            text-align: center;
            background: rgba(255,255,255,0.06);
            color: white;
            width: 320px;
            outline: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }
        #login-screen input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.25);
            background: rgba(255,255,255,0.08);
        }
        #login-screen input::placeholder { color: rgba(255,255,255,0.35); }
        .btn-start {
            padding: 16px 64px;
            font-size: 18px;
            background: linear-gradient(135deg, var(--accent-strong) 0%, var(--accent) 100%);
            border: none;
            border-radius: var(--radius-xl);
            margin-top: 28px;
            cursor: pointer;
            color: #0a0c10;
            font-weight: 700;
            box-shadow: 0 4px 24px rgba(79, 195, 247, 0.35);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
            letter-spacing: 1px;
        }
        .btn-start:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 32px rgba(79, 195, 247, 0.5);
        }
        .btn-start:active {
            transform: translateY(0) scale(0.98);
        }

        /* === 游戏页面 === */
        #game-screen { display: none; height: 100vh; flex-direction: column; }

        /* === 顶部栏 === */
        .game-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            background: linear-gradient(180deg, var(--surface) 0%, var(--surface-2) 100%);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            min-height: 56px;
            z-index: 100;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .table-title {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 0.5px;
        }
        .hand-badge {
            background: linear-gradient(135deg, var(--accent-strong) 0%, var(--accent) 100%);
            color: #0a0c10;
            padding: 4px 12px;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 700;
        }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--muted);
        }
        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }
        .status-dot.disconnected {
            background: var(--danger);
            box-shadow: 0 0 8px rgba(239, 83, 80, 0.5);
        }
        .header-right {
            display: flex;
            gap: 12px;
        }
        .header-btn {
            padding: 8px 18px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.04);
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .header-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.25);
        }
        .btn-end {
            border-color: rgba(239, 83, 80, 0.4);
            color: var(--danger);
        }
        .btn-end:hover {
            background: rgba(239, 83, 80, 0.15);
            border-color: var(--danger);
        }

        /* === 主布局 === */
        .game-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* === 牌桌区域 === */
        .table-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: radial-gradient(ellipse at center, #141a26 0%, #0a0c10 100%);
            padding: 24px;
        }

        /* === 椭圆牌桌 === */
        .poker-table-container {
            position: relative;
            width: 88%;
            max-width: 820px;
            aspect-ratio: 1.75 / 1;
            filter: drop-shadow(0 12px 40px rgba(0, 0, 0, 0.5));
        }
        .poker-table {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 78%;
            height: 68%;
            background: linear-gradient(180deg, #1a2636 0%, #243448 40%, #1a2636 100%);
            border-radius: 50%;
            border: 10px solid #2a3a4e;
            box-shadow:
                inset 0 0 100px rgba(0,0,0,0.5),
                inset 0 4px 30px rgba(255,255,255,0.03),
                0 0 0 5px #0f1520,
                0 16px 48px rgba(0,0,0,0.6);
        }
        .table-felt {
            position: absolute;
            top: 12px; left: 12px; right: 12px; bottom: 12px;
            border-radius: 50%;
            border: 2px solid rgba(79, 195, 247, 0.08);
            box-shadow: inset 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        /* === 底池 === */
        .pot-display {
            position: absolute;
            top: 62%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(10, 12, 16, 0.92) 0%, rgba(20, 26, 36, 0.95) 100%);
            padding: 10px 28px;
            border-radius: var(--radius-xl);
            font-size: 15px;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
            z-index: 15;
            border: 2px solid rgba(79, 195, 247, 0.25);
            backdrop-filter: blur(12px);
            box-shadow: var(--shadow-md), 0 0 24px rgba(79, 195, 247, 0.1);
            pointer-events: none;
        }
        .pot-label { color: var(--muted); font-size: 13px; }
        .pot-amount {
            color: var(--gold);
            font-size: 20px;
            margin-left: 6px;
            text-shadow: 0 0 12px rgba(255, 213, 79, 0.4);
        }

        /* === 公共牌 === */
        #community-cards {
            position: absolute;
            top: 36%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        /* === 扑克牌样式 === */
        .card {
            width: 50px;
            height: 70px;
            background: linear-gradient(145deg, #ffffff 0%, #f0f4f8 100%);
            border-radius: var(--radius-sm);
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            box-shadow: var(--shadow-sm), 0 1px 2px rgba(0,0,0,0.2);
            position: relative;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            line-height: 1.1;
            border: 1px solid #dde4ec;
        }
        .card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-md);
        }
        .card .card-rank { font-size: 18px; font-weight: 800; }
        .card .card-suit { font-size: 20px; margin-top: -3px; }
        .card.red { color: #c62828; }
        .card.black { color: #1a1a1a; }
        .card.card-back {
            background: linear-gradient(145deg, #1a237e 0%, #303f9f 50%, #1a237e 100%);
            border: 2px solid #3f51b5;
            color: transparent;
        }
        .card.card-back::after {
            content: '';
            position: absolute;
            top: 5px; left: 5px; right: 5px; bottom: 5px;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 3px;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 3px,
                rgba(255,255,255,0.03) 3px,
                rgba(255,255,255,0.03) 6px
            );
        }
        .card.card-placeholder {
            background: rgba(255,255,255,0.05);
            border: 2px dashed rgba(255,255,255,0.12);
            box-shadow: none;
        }
        .card.my-card {
            border: 2px solid var(--accent);
            box-shadow: 0 0 16px rgba(79, 195, 247, 0.5), var(--shadow-sm);
            animation: card-glow 2s ease-in-out infinite;
        }

        @keyframes card-glow {
            0%, 100% { box-shadow: 0 0 16px rgba(79, 195, 247, 0.5), var(--shadow-sm); }
            50% { box-shadow: 0 0 24px rgba(79, 195, 247, 0.7), var(--shadow-sm); }
        }

        /* 社区牌稍大 */
        #community-cards .card {
            width: 54px;
            height: 76px;
            font-size: 17px;
        }
        #community-cards .card .card-rank { font-size: 19px; }
        #community-cards .card .card-suit { font-size: 22px; }

        /* === 玩家区域 === */
        #players-area {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        .player-wrapper {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        /* === 玩家卡片 === */
        .player-box {
            background: linear-gradient(145deg, rgba(26, 34, 48, 0.95) 0%, rgba(14, 18, 26, 0.98) 100%);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-lg);
            padding: 10px 12px;
            min-width: 130px;
            text-align: left;
            backdrop-filter: blur(16px);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-md);
        }
        .player-box.active-turn {
            border-color: var(--accent);
            box-shadow: 0 0 28px rgba(79, 195, 247, 0.5), 0 0 56px rgba(79, 195, 247, 0.15), var(--shadow-md);
            background: linear-gradient(145deg, rgba(79, 195, 247, 0.12) 0%, rgba(41, 182, 246, 0.08) 100%);
            transform: scale(1.03);
        }
        .player-box.folded {
            opacity: 0.4;
            filter: grayscale(85%);
        }
        .player-box.is-me {
            background: linear-gradient(145deg, rgba(79, 195, 247, 0.15) 0%, rgba(41, 182, 246, 0.1) 100%);
            border-color: rgba(79, 195, 247, 0.4);
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.25), var(--shadow-md);
        }

        /* 玩家头像区 */
        .player-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(145deg, #5c6bc0 0%, #7e57c2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            flex-shrink: 0;
            box-shadow: 0 3px 10px rgba(92, 107, 192, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.15);
        }
        .player-info {
            flex: 1;
            min-width: 0;
        }
        .p-name-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 3px;
        }
        .p-name {
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
            color: #f0f4f8;
        }
        .p-host-icon { font-size: 12px; }

        /* 手牌显示 (在名字右边) */
        .player-cards {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }
        .player-cards .card {
            width: 34px;
            height: 48px;
            font-size: 12px;
        }
        .player-cards .card .card-rank { font-size: 14px; }
        .player-cards .card .card-suit { font-size: 15px; }

        /* === 位置徽章 + 筹码行 === */
        .p-bottom-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }
        .position-badge {
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #fff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
        }
        .pos-btn { background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%); }
        .pos-sb { background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%); }
        .pos-bb { background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%); }
        .pos-utg { background: linear-gradient(135deg, #64748b 0%, #475569 100%); }
        .pos-mp { background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%); }
        .pos-hj { background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); }
        .pos-co { background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%); }
        .pos-dealer { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #1a1a1a; }

        .p-chips {
            color: var(--gold);
            font-size: 13px;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .p-loan {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(255,255,255,0.06);
            color: var(--muted);
        }

        /* === 座位定位 - 使用对称布局 === */
        /* 默认9人座位 */
        .player-wrapper.seat-0 { top: -6%; left: 50%; transform: translateX(-50%); }
        .player-wrapper.seat-1 { top: 5%; right: 2%; }
        .player-wrapper.seat-2 { top: 35%; right: -4%; }
        .player-wrapper.seat-3 { bottom: 15%; right: 2%; }
        .player-wrapper.seat-4 { bottom: -6%; right: 25%; }
        .player-wrapper.seat-5 { bottom: -6%; left: 25%; }
        .player-wrapper.seat-6 { bottom: 15%; left: 2%; }
        .player-wrapper.seat-7 { top: 35%; left: -4%; }
        .player-wrapper.seat-8 { top: 5%; left: 2%; }

        /* 2人定位 - 上下对称 */
        .players-2 .player-wrapper.seat-0 { top: -10%; left: 50%; transform: translateX(-50%); }
        .players-2 .player-wrapper.seat-1 { bottom: -10%; left: 50%; transform: translateX(-50%); }

        /* 3人定位 - 三角形对称 */
        .players-3 .player-wrapper.seat-0 { top: -10%; left: 50%; transform: translateX(-50%); }
        .players-3 .player-wrapper.seat-1 { bottom: -4%; right: 12%; }
        .players-3 .player-wrapper.seat-2 { bottom: -4%; left: 12%; }

        /* 4人定位 - 菱形对称 */
        .players-4 .player-wrapper.seat-0 { top: -8%; left: 50%; transform: translateX(-50%); }
        .players-4 .player-wrapper.seat-1 { top: 38%; right: -2%; }
        .players-4 .player-wrapper.seat-2 { bottom: -8%; left: 50%; transform: translateX(-50%); }
        .players-4 .player-wrapper.seat-3 { top: 38%; left: -2%; }

        /* 5人定位 - 五边形对称 */
        .players-5 .player-wrapper.seat-0 { top: -8%; left: 50%; transform: translateX(-50%); }
        .players-5 .player-wrapper.seat-1 { top: 18%; right: 0%; }
        .players-5 .player-wrapper.seat-2 { bottom: 2%; right: 8%; }
        .players-5 .player-wrapper.seat-3 { bottom: 2%; left: 8%; }
        .players-5 .player-wrapper.seat-4 { top: 18%; left: 0%; }

        /* 6人定位 - 六边形对称 */
        .players-6 .player-wrapper.seat-0 { top: -6%; left: 50%; transform: translateX(-50%); }
        .players-6 .player-wrapper.seat-1 { top: 15%; right: -2%; }
        .players-6 .player-wrapper.seat-2 { bottom: 15%; right: -2%; }
        .players-6 .player-wrapper.seat-3 { bottom: -6%; left: 50%; transform: translateX(-50%); }
        .players-6 .player-wrapper.seat-4 { bottom: 15%; left: -2%; }
        .players-6 .player-wrapper.seat-5 { top: 15%; left: -2%; }

        /* 7人定位 */
        .players-7 .player-wrapper.seat-0 { top: -6%; left: 50%; transform: translateX(-50%); }
        .players-7 .player-wrapper.seat-1 { top: 8%; right: 0%; }
        .players-7 .player-wrapper.seat-2 { top: 42%; right: -4%; }
        .players-7 .player-wrapper.seat-3 { bottom: 5%; right: 10%; }
        .players-7 .player-wrapper.seat-4 { bottom: 5%; left: 10%; }
        .players-7 .player-wrapper.seat-5 { top: 42%; left: -4%; }
        .players-7 .player-wrapper.seat-6 { top: 8%; left: 0%; }

        /* 8人定位 */
        .players-8 .player-wrapper.seat-0 { top: -6%; left: 50%; transform: translateX(-50%); }
        .players-8 .player-wrapper.seat-1 { top: 6%; right: 2%; }
        .players-8 .player-wrapper.seat-2 { top: 38%; right: -3%; }
        .players-8 .player-wrapper.seat-3 { bottom: 10%; right: 5%; }
        .players-8 .player-wrapper.seat-4 { bottom: -6%; left: 50%; transform: translateX(-50%); }
        .players-8 .player-wrapper.seat-5 { bottom: 10%; left: 5%; }
        .players-8 .player-wrapper.seat-6 { top: 38%; left: -3%; }
        .players-8 .player-wrapper.seat-7 { top: 6%; left: 2%; }

        /* === 开始按钮 === */
        .start-btn-container {
            position: absolute;
            bottom: 18%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
        }

        /* === 下注筹码 (牌桌上) === */
        .bet-chip {
            position: absolute;
            z-index: 8;
            display: flex;
            align-items: center;
            gap: 5px;
            pointer-events: none;
        }
        .chip-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(145deg, #ffd54f 0%, #ffb300 100%);
            border: 3px solid #fff8e1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 800;
            color: #5d4037;
            box-shadow: 0 4px 12px rgba(255, 213, 79, 0.5), 0 2px 4px rgba(0,0,0,0.3);
        }
        .chip-amount {
            background: linear-gradient(145deg, rgba(10, 12, 16, 0.95) 0%, rgba(20, 26, 36, 0.98) 100%);
            padding: 5px 12px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 700;
            color: var(--gold);
            white-space: nowrap;
            border: 1px solid rgba(255, 213, 79, 0.25);
            box-shadow: var(--shadow-sm);
        }

        /* === 弃牌标记 === */
        .fold-label {
            color: var(--danger);
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(239, 83, 80, 0.15);
            padding: 3px 10px;
            border-radius: var(--radius-sm);
        }
        .fold-label .fold-x {
            font-size: 13px;
            font-weight: 900;
        }

        /* === 行动中标记 === */
        .turn-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            background: rgba(79, 195, 247, 0.1);
            padding: 4px 12px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(79, 195, 247, 0.2);
        }
        .turn-label {
            color: var(--accent);
            font-size: 11px;
            font-weight: 600;
        }
        .turn-timer {
            background: rgba(79, 195, 247, 0.2);
            border: 1px solid rgba(79, 195, 247, 0.35);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            color: var(--accent);
            font-size: 12px;
            font-weight: 700;
            min-width: 32px;
            text-align: center;
        }

        /* === 操作标签 === */
        .p-action {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            display: inline-block;
            font-weight: 700;
            margin-top: 3px;
        }
        .p-action.fold-action { background: rgba(239, 83, 80, 0.2); color: var(--danger); }
        .p-action.check-action { background: rgba(79, 195, 247, 0.2); color: var(--accent); }
        .p-action.call-action { background: rgba(129, 140, 248, 0.2); color: #a5b4fc; }
        .p-action.raise-action { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        .p-action.allin-action {
            background: linear-gradient(135deg, rgba(239, 83, 80, 0.4), rgba(233, 57, 53, 0.4));
            color: #fff;
            animation: pulse-allin 1.2s ease-in-out infinite;
        }
        @keyframes pulse-allin {
            0%, 100% { box-shadow: 0 0 6px rgba(239, 83, 80, 0.4); }
            50% { box-shadow: 0 0 16px rgba(239, 83, 80, 0.8); }
        }

        /* === 系统日志 === */
        #logs {
            position: absolute;
            bottom: 12px;
            left: 16px;
            max-width: 360px;
            font-size: 11px;
            color: var(--muted);
            max-height: 56px;
            overflow-y: auto;
            text-align: left;
            background: rgba(10, 12, 16, 0.85);
            padding: 8px 12px;
            border-radius: var(--radius-md);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        #logs::-webkit-scrollbar { width: 3px; }
        #logs::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }

        .btn-start-game {
            padding: 16px 48px;
            background: linear-gradient(145deg, #2563eb 0%, #3b82f6 100%);
            border: none;
            color: white;
            border-radius: var(--radius-xl);
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4), var(--shadow-sm);
            transition: all 0.3s ease;
            border: 2px solid rgba(147, 197, 253, 0.25);
            letter-spacing: 0.5px;
        }
        .btn-start-game:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.55), var(--shadow-md);
        }
        .btn-start-game:active {
            transform: translateY(0) scale(0.98);
        }
        .btn-start-game:disabled {
            background: linear-gradient(145deg, #475569 0%, #334155 100%);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            opacity: 0.6;
            border-color: transparent;
        }

        /* === 右侧边栏 === */
        .sidebar {
            width: 340px;
            min-width: 340px;
            background: linear-gradient(180deg, var(--surface-2) 0%, var(--surface) 100%);
            border-left: 1px solid rgba(255,255,255,0.06);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .sidebar::-webkit-scrollbar { width: 5px; }
        .sidebar::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

        /* === 面板通用 === */
        .panel {
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 14px;
            font-weight: 700;
        }
        .panel-body {
            padding: 14px 18px;
        }

        /* === Toggle开关 === */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #475569;
            border-radius: 24px;
            transition: 0.3s;
        }
        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch input:checked + .toggle-slider { background: var(--accent-strong); }
        .toggle-switch input:checked + .toggle-slider::before { transform: translateX(20px); }
        .toggle-label {
            font-size: 12px;
            color: var(--muted);
            margin-left: 8px;
        }

        /* === AI助手 === */
        .ai-section {
            margin-bottom: 16px;
        }
        .ai-section:last-child { margin-bottom: 0; }
        .ai-label {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .hand-strength-box {
            background: rgba(255,255,255,0.03);
            border-radius: var(--radius-md);
            padding: 12px 14px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .hand-type {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 8px;
            color: #f0f4f8;
        }
        .strength-bar-container {
            height: 8px;
            background: rgba(255,255,255,0.08);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }
        .strength-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, #818cf8 50%, #f472b6 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }
        .strength-text {
            font-size: 12px;
            color: var(--muted);
            text-align: right;
        }

        .rating-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .rating-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: var(--radius-md);
            padding: 10px 14px;
            text-align: center;
        }
        .rating-label {
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 4px;
        }
        .rating-value {
            font-size: 17px;
            font-weight: 700;
        }

        .winrate-row {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: var(--muted);
        }
        .winrate-bar-container {
            flex: 1;
            height: 10px;
            background: rgba(255,255,255,0.08);
            border-radius: 5px;
            overflow: hidden;
        }
        .winrate-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--success) 100%);
            border-radius: 5px;
            transition: width 0.5s ease;
            width: 0%;
        }
        .winrate-value {
            font-weight: 700;
            color: #fff;
            min-width: 48px;
            text-align: right;
        }

        .pot-odds-row {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 11px;
            color: var(--muted);
        }
        .pot-odds-label {
            white-space: nowrap;
        }
        .pot-odds-bar-container {
            flex: 1;
            height: 10px;
            background: rgba(255,255,255,0.08);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        .pot-odds-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, #818cf8 100%);
            border-radius: 5px;
            transition: width 0.5s ease;
            width: 0%;
        }
        .pot-odds-marker {
            position: absolute;
            top: -4px;
            width: 3px;
            height: 18px;
            background: var(--danger);
            border-radius: 2px;
            transition: left 0.5s ease;
        }

        /* === 玩家操作面板 === */
        .action-panel .panel-body { padding: 14px 18px; }

        .bet-section { margin-bottom: 14px; }
        .bet-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .bet-label {
            font-size: 13px;
            font-weight: 700;
        }
        .effective-stack {
            font-size: 12px;
            color: #93c5fd;
            font-weight: 600;
        }
        .bet-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }
        .bet-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: var(--radius-sm);
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 17px;
            font-weight: 700;
            outline: none;
            transition: all 0.2s ease;
        }
        .bet-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 12px rgba(79, 195, 247, 0.2);
        }
        .bb-display {
            font-size: 12px;
            color: var(--muted);
            white-space: nowrap;
        }
        .bet-range {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 8px;
        }

        /* 滑块 */
        .raise-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, var(--accent) 0%, #818cf8 50%, #f472b6 100%);
            outline: none;
            margin-bottom: 14px;
        }
        .raise-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid var(--accent-strong);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: transform 0.15s ease;
        }
        .raise-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        /* 快捷按钮 */
        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 14px;
        }
        .quick-btn {
            padding: 8px 4px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.04);
            color: #e2e8f0;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quick-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }
        .quick-btn.allin {
            background: linear-gradient(145deg, var(--danger) 0%, var(--danger-strong) 100%);
            border-color: var(--danger-strong);
            color: #fff;
        }
        .quick-btn.allin:hover {
            background: linear-gradient(145deg, var(--danger-strong) 0%, #c62828 100%);
        }

        /* 操作按钮 */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .action-btn {
            padding: 14px 10px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            color: #fff;
            transition: all 0.15s ease;
        }
        .action-btn:active { transform: scale(0.96); }
        .action-btn:disabled { opacity: 0.35; cursor: not-allowed; }
        .btn-fold {
            background: linear-gradient(145deg, #64748b 0%, #475569 100%);
        }
        .btn-fold:hover:not(:disabled) {
            background: linear-gradient(145deg, #475569 0%, #334155 100%);
        }
        .btn-call {
            background: linear-gradient(145deg, #22d3ee 0%, #06b6d4 100%);
        }
        .btn-call:hover:not(:disabled) {
            background: linear-gradient(145deg, #06b6d4 0%, #0891b2 100%);
        }
        .btn-raise {
            background: linear-gradient(145deg, #3b82f6 0%, #2563eb 100%);
        }
        .btn-raise:hover:not(:disabled) {
            background: linear-gradient(145deg, #2563eb 0%, #1d4ed8 100%);
        }
        .btn-allin {
            background: linear-gradient(145deg, var(--danger) 0%, var(--danger-strong) 100%);
        }
        .btn-allin:hover:not(:disabled) {
            background: linear-gradient(145deg, var(--danger-strong) 0%, #c62828 100%);
        }

        .action-btn .btn-sub {
            display: block;
            font-size: 11px;
            font-weight: 500;
            opacity: 0.85;
            margin-top: 3px;
        }

        /* === 聊天浮窗 === */
        .chat-float-btn {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(145deg, var(--accent-strong) 0%, var(--accent) 100%);
            border: none;
            color: #0a0c10;
            font-size: 20px;
            cursor: pointer;
            z-index: 50;
            box-shadow: var(--shadow-md);
            transition: all 0.2s ease;
        }
        .chat-float-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(79, 195, 247, 0.4);
        }

        .chat-popup {
            position: absolute;
            bottom: 68px;
            right: 12px;
            width: 320px;
            max-height: 340px;
            background: rgba(14, 18, 26, 0.98);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: var(--radius-lg);
            z-index: 50;
            display: none;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(16px);
            box-shadow: var(--shadow-lg);
        }
        .chat-popup.open { display: flex; }
        .chat-popup-header {
            padding: 12px 16px;
            background: rgba(0,0,0,0.3);
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        #chat-messages {
            flex: 1;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px 14px;
            font-size: 13px;
            text-align: left;
        }
        #chat-messages::-webkit-scrollbar { width: 4px; }
        #chat-messages::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
        .chat-msg { margin-bottom: 6px; line-height: 1.5; }
        .chat-msg .chat-name { color: var(--accent); font-weight: 700; }
        .chat-msg .chat-text { color: #f0f4f8; }
        .chat-msg .chat-time { color: #555; font-size: 10px; margin-left: 6px; }
        .chat-input-row {
            display: flex;
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        #chat-input {
            flex: 1;
            padding: 10px 14px;
            border: none;
            background: rgba(255,255,255,0.04);
            color: white;
            font-size: 13px;
            outline: none;
        }
        #chat-input::placeholder { color: rgba(255,255,255,0.3); }
        .chat-send-btn {
            padding: 10px 16px;
            background: var(--accent-strong);
            border: none;
            color: #0a0c10;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .chat-send-btn:hover { background: var(--accent); }

        .emoji-bar {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 6px;
            padding: 10px 12px;
            border-top: 1px solid rgba(255,255,255,0.06);
            background: rgba(255,255,255,0.02);
        }
        .emoji-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.03);
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }
        .emoji-btn:hover {
            transform: scale(1.15);
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }

        .emoji-float {
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 36px;
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.5));
            animation: emoji-pop 1.8s ease forwards;
            pointer-events: none;
            z-index: 30;
        }
        @keyframes emoji-pop {
            0% { opacity: 0; transform: translate(-50%, 10px) scale(0.6); }
            15% { opacity: 1; transform: translate(-50%, 0) scale(1.1); }
            25% { transform: translate(-50%, 0) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -24px) scale(1.05); }
        }

        /* === 赢牌特效 === */
        .winning-card {
            border: 3px solid var(--gold) !important;
            box-shadow: 0 0 20px rgba(255, 213, 79, 0.6), 0 0 40px rgba(255, 213, 79, 0.3) !important;
            transform: translateY(-8px) scale(1.08);
            z-index: 100;
            animation: glow-gold 1s ease-in-out infinite alternate;
        }
        @keyframes glow-gold {
            from { box-shadow: 0 0 20px rgba(255, 213, 79, 0.6), 0 0 40px rgba(255, 213, 79, 0.3); }
            to { box-shadow: 0 0 30px rgba(255, 213, 79, 0.8), 0 0 60px rgba(255, 213, 79, 0.5); }
        }

        /* === 响应式设计 === */
        @media (max-width: 1024px) {
            .sidebar { width: 300px; min-width: 300px; }
        }

        @media (max-width: 768px) {
            .game-layout { flex-direction: column; }
            .sidebar {
                width: 100%;
                min-width: 100%;
                max-height: 38vh;
                border-left: none;
                border-top: 1px solid rgba(255,255,255,0.06);
            }
            .table-area {
                min-height: 58vh;
                padding: 12px;
            }
            .poker-table-container {
                max-width: 96%;
                aspect-ratio: 1.6 / 1;
            }

            /* 移动端顶部栏 */
            .game-header {
                padding: 10px 16px;
                min-height: 48px;
            }
            .header-left { gap: 10px; }
            .table-title { font-size: 16px; }
            .hand-badge { font-size: 11px; padding: 3px 8px; }
            .header-btn { padding: 6px 12px; font-size: 12px; }

            /* 移动端底池位置优化 */
            .pot-display {
                top: 62%;
                padding: 8px 18px;
                font-size: 13px;
            }
            .pot-label { font-size: 12px; }
            .pot-amount { font-size: 16px; }

            /* 移动端公共牌位置优化 */
            #community-cards {
                top: 34%;
                gap: 5px;
            }
            #community-cards .card {
                width: 44px;
                height: 62px;
                font-size: 14px;
            }
            #community-cards .card .card-rank { font-size: 16px; }
            #community-cards .card .card-suit { font-size: 18px; }

            /* 移动端玩家框优化 */
            .player-box {
                min-width: 95px;
                padding: 6px 8px;
                gap: 6px;
                border-radius: var(--radius-md);
            }
            .player-avatar {
                width: 26px;
                height: 26px;
                font-size: 12px;
                border-width: 1.5px;
            }
            .p-name { font-size: 11px; max-width: 50px; }
            .p-chips { font-size: 11px; }
            .p-loan { display: none; }
            .position-badge { font-size: 8px; padding: 2px 5px; }
            .player-cards .card { width: 24px; height: 34px; font-size: 9px; }
            .player-cards .card .card-rank { font-size: 11px; }
            .player-cards .card .card-suit { font-size: 12px; }

            /* 移动端开始按钮 */
            .start-btn-container { bottom: 10%; }
            .btn-start-game {
                padding: 12px 32px;
                font-size: 16px;
                border-radius: var(--radius-lg);
            }

            /* 移动端筹码优化 */
            .bet-chip { z-index: 12; }
            .chip-icon {
                width: 24px;
                height: 24px;
                font-size: 9px;
                border-width: 2px;
            }
            .chip-amount {
                font-size: 11px;
                padding: 3px 8px;
            }

            /* 移动端座位定位 - 对称优化 */
            /* 2人 */
            .players-2 .player-wrapper.seat-0 { top: -14%; }
            .players-2 .player-wrapper.seat-1 { bottom: -14%; }

            /* 3人 */
            .players-3 .player-wrapper.seat-0 { top: -14%; }
            .players-3 .player-wrapper.seat-1 { bottom: -8%; right: 5%; }
            .players-3 .player-wrapper.seat-2 { bottom: -8%; left: 5%; }

            /* 4人 */
            .players-4 .player-wrapper.seat-0 { top: -14%; }
            .players-4 .player-wrapper.seat-1 { top: 32%; right: -6%; }
            .players-4 .player-wrapper.seat-2 { bottom: -14%; }
            .players-4 .player-wrapper.seat-3 { top: 32%; left: -6%; }

            /* 5人 */
            .players-5 .player-wrapper.seat-0 { top: -14%; }
            .players-5 .player-wrapper.seat-1 { top: 12%; right: -6%; }
            .players-5 .player-wrapper.seat-2 { bottom: -6%; right: 8%; }
            .players-5 .player-wrapper.seat-3 { bottom: -6%; left: 8%; }
            .players-5 .player-wrapper.seat-4 { top: 12%; left: -6%; }

            /* 6人 */
            .players-6 .player-wrapper.seat-0 { top: -14%; }
            .players-6 .player-wrapper.seat-1 { top: 10%; right: -8%; }
            .players-6 .player-wrapper.seat-2 { bottom: 10%; right: -8%; }
            .players-6 .player-wrapper.seat-3 { bottom: -14%; }
            .players-6 .player-wrapper.seat-4 { bottom: 10%; left: -8%; }
            .players-6 .player-wrapper.seat-5 { top: 10%; left: -8%; }

            /* 7-9人拥挤模式 */
            .players-crowded .player-box {
                min-width: 78px;
                padding: 5px 6px;
                gap: 4px;
            }
            .players-crowded .player-avatar {
                width: 22px;
                height: 22px;
                font-size: 10px;
            }
            .players-crowded .p-name {
                font-size: 9px;
                max-width: 38px;
            }
            .players-crowded .p-chips { font-size: 10px; }
            .players-crowded .position-badge {
                font-size: 7px;
                padding: 1px 4px;
            }
            .players-crowded .player-cards .card {
                width: 20px;
                height: 28px;
                font-size: 8px;
            }
            .players-crowded .player-cards .card .card-rank { font-size: 9px; }
            .players-crowded .player-cards .card .card-suit { font-size: 10px; }

            .table-crowded .chip-icon {
                width: 20px;
                height: 20px;
                font-size: 8px;
                border-width: 2px;
            }
            .table-crowded .chip-amount {
                font-size: 10px;
                padding: 2px 6px;
            }

            /* 移动端侧边栏面板 */
            .panel-header { padding: 10px 14px; font-size: 13px; }
            .panel-body { padding: 10px 14px; }
            .ai-section { margin-bottom: 12px; }
            .hand-type { font-size: 16px; }
            .rating-value { font-size: 15px; }

            /* 移动端操作按钮 */
            .quick-buttons {
                grid-template-columns: repeat(5, 1fr);
                gap: 6px;
            }
            .quick-btn { padding: 6px 2px; font-size: 11px; }
            .action-btn { padding: 12px 8px; font-size: 13px; }

            /* 移动端聊天 */
            .chat-popup {
                width: 280px;
                max-height: 300px;
                bottom: 60px;
            }
            .chat-float-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            .emoji-bar {
                grid-template-columns: repeat(9, 1fr);
                gap: 4px;
                padding: 8px 10px;
            }
            .emoji-btn {
                width: 28px;
                height: 28px;
                font-size: 16px;
            }

            /* 移动端日志 */
            #logs {
                max-width: 280px;
                font-size: 10px;
                padding: 6px 10px;
            }
        }

        /* 小屏手机优化 */
        @media (max-width: 480px) {
            .table-area { padding: 8px; min-height: 55vh; }
            .poker-table-container { aspect-ratio: 1.5 / 1; }

            #community-cards .card {
                width: 38px;
                height: 54px;
                font-size: 12px;
            }
            #community-cards .card .card-rank { font-size: 14px; }
            #community-cards .card .card-suit { font-size: 16px; }

            .player-box {
                min-width: 80px;
                padding: 5px 6px;
            }
            .player-avatar { width: 22px; height: 22px; font-size: 10px; }
            .p-name { font-size: 10px; max-width: 40px; }
            .p-chips { font-size: 10px; }
            .position-badge { font-size: 7px; padding: 1px 4px; }
            .player-cards .card { width: 20px; height: 28px; }
            .player-cards .card .card-rank { font-size: 10px; }
            .player-cards .card .card-suit { font-size: 11px; }

            .pot-display { padding: 6px 14px; }
            .pot-label { font-size: 11px; }
            .pot-amount { font-size: 14px; }

            .btn-start-game { padding: 10px 24px; font-size: 14px; }

            .sidebar { max-height: 42vh; }
            .quick-buttons { gap: 4px; }
            .action-btn { padding: 10px 6px; font-size: 12px; }
        }

        /* 横屏模式优化 */
        @media (max-height: 500px) and (orientation: landscape) {
            .game-layout { flex-direction: row; }
            .sidebar {
                width: 280px;
                min-width: 280px;
                max-height: 100%;
                border-top: none;
                border-left: 1px solid rgba(255,255,255,0.06);
            }
            .table-area { min-height: auto; }
        }
    </style>
</head>
<body>

    <!-- 登录页 -->
    <div id="login-screen">
        <h1>♠ 德州扑克 ♥</h1>
        <input type="text" id="nickname" placeholder="输入昵称" maxlength="12">
        <button class="btn-start" onclick="joinGame()">🎰 入座</button>
    </div>

    <!-- 游戏页 -->
    <div id="game-screen">
        <!-- 顶部栏 -->
        <header class="game-header">
            <div class="header-left">
                <h1 class="table-title" id="table-title">6人桌</h1>
                <span class="hand-badge">手牌 #<span id="hand-number">0</span></span>
                <span class="connection-status">
                    <span class="status-dot" id="status-dot"></span>
                    <span id="connection-text">已连接</span>
                </span>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="togglePause()" id="pause-btn">⏸ 暂停</button>
                <button class="header-btn btn-end" onclick="endGame()">⏹ 结束</button>
            </div>
        </header>

        <!-- 主布局 -->
        <div class="game-layout">
            <!-- 牌桌区域 -->
            <div class="table-area">
                <div class="poker-table-container">
                    <div class="poker-table" id="poker-table">
                        <div class="table-felt">
                            <div class="pot-display">
                                <span class="pot-label">底池: </span>
                                <span class="pot-amount" id="pot-num">0</span>
                            </div>
                            <div id="community-cards"></div>
                        </div>
                        <div id="bet-chips-area"></div>
                    </div>
                    <div id="players-area"></div>
                </div>

                <!-- 开始按钮 -->
                <div class="start-btn-container" id="start-container">
                    <button id="start-game-btn" class="btn-start-game" onclick="socket.emit('start_game')">🎮 开始游戏</button>
                </div>

                <!-- 聊天浮窗 -->
                <button class="chat-float-btn" onclick="toggleChat()" id="chat-toggle-btn">💬</button>
                <div class="chat-popup" id="chat-popup">
                    <div class="chat-popup-header">💬 聊天室</div>
                    <div id="chat-messages"></div>
                    <div class="emoji-bar" id="emoji-bar"></div>
                    <div class="chat-input-row">
                        <input type="text" id="chat-input" placeholder="输入消息..." maxlength="200" onkeypress="if(event.key==='Enter')sendChatMsg()">
                        <button class="chat-send-btn" onclick="sendChatMsg()">发送</button>
                    </div>
                </div>

                <div id="logs"></div>
            </div>

            <!-- 侧边栏 -->
            <div class="sidebar" id="sidebar">
                <!-- AI助手面板 -->
                <div class="panel ai-panel">
                    <div class="panel-header">
                        <span>🤖 AI助手</span>
                        <div style="display:flex;align-items:center;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="ai-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label" id="ai-toggle-label">开启</span>
                        </div>
                    </div>
                    <div class="panel-body" id="ai-content">
                        <div class="ai-section">
                            <div class="ai-label">手牌强度</div>
                            <div class="hand-strength-box">
                                <div class="hand-type" id="hand-type">等待发牌</div>
                                <div class="strength-bar-container">
                                    <div class="strength-bar" id="strength-bar" style="width:0%"></div>
                                </div>
                                <div class="strength-text" id="strength-text">--</div>
                            </div>
                        </div>
                        <div class="ai-section">
                            <div class="ai-label">翻前评级</div>
                            <div class="rating-grid">
                                <div class="rating-item">
                                    <div class="rating-label">排名</div>
                                    <div class="rating-value" id="hand-rank">--</div>
                                </div>
                                <div class="rating-item">
                                    <div class="rating-label">等级</div>
                                    <div class="rating-value" id="hand-tier">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="ai-section">
                            <div class="ai-label">胜率估算</div>
                            <div class="winrate-row">
                                <span>vs 随机手牌</span>
                                <div class="winrate-bar-container">
                                    <div class="winrate-bar" id="winrate-bar" style="width:0%"></div>
                                </div>
                                <span class="winrate-value" id="winrate-value">--</span>
                            </div>
                        </div>
                        <div class="ai-section">
                            <div class="ai-label">底池赔率分析</div>
                            <div class="pot-odds-row">
                                <span class="pot-odds-label">你的赔率</span>
                                <div class="pot-odds-bar-container">
                                    <div class="pot-odds-bar" id="pot-odds-bar" style="width:0%"></div>
                                    <div class="pot-odds-marker" id="pot-odds-marker" style="left:0%"></div>
                                </div>
                                <span class="pot-odds-label">所需赔率</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 玩家操作面板 -->
                <div class="panel action-panel">
                    <div class="panel-header">
                        <span>🎮 玩家操作</span>
                    </div>
                    <div class="panel-body" id="action-content">
                        <div class="bet-section">
                            <div class="bet-header">
                                <span class="bet-label">下注金额</span>
                                <span class="effective-stack" id="effective-stack">有效积分: --</span>
                            </div>
                            <div class="bet-input-row">
                                <input type="number" id="bet-input" class="bet-input" value="0" oninput="updateSliderFromInput()">
                                <span class="bb-display" id="bb-display">(0 BB)</span>
                            </div>
                            <div class="bet-range" id="bet-range">范围: 0 - 0</div>
                            <input type="range" id="raise-slider" class="raise-slider" min="0" max="1000" value="0" oninput="updateBetFromSlider()">
                        </div>
                        <div class="quick-buttons">
                            <button class="quick-btn" onclick="quickRaise('min')">最小</button>
                            <button class="quick-btn" onclick="quickRaise('3bb')">3BB</button>
                            <button class="quick-btn" onclick="quickRaise('4bb')">4BB</button>
                            <button class="quick-btn" onclick="quickRaise('5bb')">5BB</button>
                            <button class="quick-btn allin" onclick="quickRaise('allin')">全押</button>
                        </div>
                        <div class="action-buttons" id="action-buttons">
                            <button class="action-btn btn-fold" onclick="sendAction('fold')" id="btn-fold">弃牌</button>
                            <button class="action-btn btn-call" onclick="handleCallCheck()" id="btn-call-check">
                                跟注
                                <span class="btn-sub" id="call-amount-text"></span>
                            </button>
                            <button class="action-btn btn-raise" onclick="handleRaise()" id="btn-raise">
                                下注
                                <span class="btn-sub" id="raise-amount-text"></span>
                            </button>
                            <button class="action-btn btn-allin" onclick="quickRaise('allin')" id="btn-allin">
                                全下
                                <span class="btn-sub" id="allin-amount-text"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ========================================
        // 连接与状态
        // ========================================
        const socket = io();
        let myId = null;
        let currentState = null;
        let currentWinners = null;
        let myPlayer = null;
        let handCount = 0;
        let turnTimer = null;
        let turnTimeLeft = 0;
        let isPaused = false;
        const playerLoanCount = {};
        const playerPrevChips = {};

        socket.on('connect', () => {
            myId = socket.id;
            document.getElementById('status-dot').classList.remove('disconnected');
            document.getElementById('connection-text').innerText = '已连接';
        });
        socket.on('disconnect', () => {
            document.getElementById('status-dot').classList.add('disconnected');
            document.getElementById('connection-text').innerText = '已断开';
        });

        function joinGame() {
            const name = document.getElementById('nickname').value.trim();
            if (!name) return alert("请输入昵称");
            socket.emit('join', name);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
        }

        // ========================================
        // 翻前手牌数据库 (TOP 50)
        // ========================================
        const HAND_RANKINGS = {
            'AA':1,'KK':2,'QQ':3,'JJ':4,'AKs':5,'AQs':6,'TT':7,'AKo':8,'AJs':9,'KQs':10,
            '99':11,'ATs':12,'KJs':13,'QJs':14,'JTs':15,'AQo':16,'88':17,'KTs':18,'QTs':19,'A9s':20,
            'T9s':21,'AJo':22,'77':23,'KQo':24,'J9s':25,'A8s':26,'K9s':27,'98s':28,'KJo':29,'A7s':30,
            '66':31,'QJo':32,'T8s':33,'A5s':34,'A6s':35,'87s':36,'KTo':37,'A4s':38,'55':39,'Q9s':40,
            '97s':41,'J8s':42,'QTo':43,'A3s':44,'76s':45,'JTo':46,'A2s':47,'44':48,'65s':49,'K8s':50,
            '86s':51,'T7s':52,'33':53,'K7s':54,'54s':55,'96s':56,'75s':57,'22':58,'J7s':59,'K6s':60,
            'T9o':61,'A9o':62,'Q8s':63,'64s':64,'K5s':65,'85s':66,'98o':67,'53s':68,'K4s':69,'J9o':70,
            'T6s':71,'Q7s':72,'K3s':73,'43s':74,'74s':75,'87o':76,'A8o':77,'K2s':78,'Q6s':79,'J6s':80,
            'T8o':81,'Q5s':82,'63s':83,'95s':84,'52s':85,'76o':86,'A7o':87,'Q4s':88,'84s':89,'42s':90,
            '97o':91,'65o':92,'T5s':93,'Q3s':94,'J8o':95,'A5o':96,'T4s':97,'73s':98,'Q2s':99,'86o':100,
            'A6o':101,'32s':102,'J5s':103,'54o':104,'T3s':105,'J4s':106,'62s':107,'A4o':108,'J3s':109,
            '75o':110,'96o':111,'A3o':112,'J2s':113,'T2s':114,'A2o':115,'64o':116,'85o':117,'53o':118,
            'K9o':119,'Q9o':120,'T7o':121,'43o':122,'74o':123,'K8o':124,'Q8o':125,'J7o':126,'K7o':127,
            'T6o':128,'K6o':129,'95o':130,'52o':131,'K5o':132,'Q7o':133,'K4o':134,'63o':135,'84o':136,
            'Q6o':137,'K3o':138,'42o':139,'Q5o':140,'K2o':141,'Q4o':142,'73o':143,'J6o':144,'Q3o':145,
            '62o':146,'J5o':147,'Q2o':148,'32o':149,'T5o':150,'J4o':151,'J3o':152,'T4o':153,'J2o':154,
            'T3o':155,'94o':156,'93o':157,'92o':158,'T2o':159,'83o':160,'82o':161,'72o':162,'63o':163,
            '43o':164,'52o':165,'42o':166,'32o':167,'73o':168,'62o':169
        };

        function getHandKey(card1, card2) {
            const RANKS = '23456789TJQKA';
            const r1 = RANKS.indexOf(card1[0]);
            const r2 = RANKS.indexOf(card2[0]);
            const suited = card1[1] === card2[1];
            const high = Math.max(r1, r2);
            const low = Math.min(r1, r2);
            const highChar = RANKS[high];
            const lowChar = RANKS[low];
            if (r1 === r2) return highChar + lowChar;
            return highChar + lowChar + (suited ? 's' : 'o');
        }

        function getHandDescription(card1, card2) {
            const RANKS = '23456789TJQKA';
            const RANK_NAMES = {'2':'2','3':'3','4':'4','5':'5','6':'6','7':'7','8':'8','9':'9','T':'10','J':'J','Q':'Q','K':'K','A':'A'};
            const r1 = RANKS.indexOf(card1[0]);
            const r2 = RANKS.indexOf(card2[0]);
            const suited = card1[1] === card2[1];
            const high = RANK_NAMES[RANKS[Math.max(r1, r2)]];
            const low = RANK_NAMES[RANKS[Math.min(r1, r2)]];
            if (r1 === r2) return '对子' + high;
            return (suited ? '同花' : '杂色') + high + low;
        }

        function getHandTier(rank) {
            if (rank <= 8) return { name: '必玩', color: '#ef4444' };
            if (rank <= 17) return { name: '强牌', color: '#f97316' };
            if (rank <= 34) return { name: '可玩', color: '#eab308' };
            if (rank <= 59) return { name: '谨慎', color: '#3b82f6' };
            if (rank <= 85) return { name: '弱牌', color: '#6b7280' };
            return { name: '不推荐', color: '#64748b' };
        }

        function estimateWinRate(rank) {
            // 从85%(AA)线性到约30%(最差){
            return Math.max(30, Math.round(85 - (rank - 1) * 55 / 168));
        }

        function updateAIPanel() {
            const aiEnabled = document.getElementById('ai-toggle').checked;
            const content = document.getElementById('ai-content');
            const label = document.getElementById('ai-toggle-label');
            label.innerText = aiEnabled ? '开启' : '关闭';

            if (!aiEnabled || !myPlayer || !myPlayer.hand || myPlayer.hand.length < 2) {
                document.getElementById('hand-type').innerText = '等待发牌';
                document.getElementById('strength-bar').style.width = '0%';
                document.getElementById('strength-text').innerText = '--';
                document.getElementById('hand-rank').innerText = '--';
                document.getElementById('hand-tier').innerText = '--';
                document.getElementById('hand-tier').style.color = '#fff';
                document.getElementById('winrate-bar').style.width = '0%';
                document.getElementById('winrate-value').innerText = '--';
                return;
            }

            const c1 = myPlayer.hand[0], c2 = myPlayer.hand[1];
            const key = getHandKey(c1, c2);
            const desc = getHandDescription(c1, c2);
            const rank = HAND_RANKINGS[key] || 100;
            const pct = Math.round((1 - (rank - 1) / 168) * 100);
            const tier = getHandTier(rank);
            const winRate = estimateWinRate(rank);

            document.getElementById('hand-type').innerText = desc;
            document.getElementById('strength-bar').style.width = pct + '%';
            document.getElementById('strength-text').innerText = 'Top ' + Math.round((rank / 169) * 100) + '%';
            document.getElementById('hand-rank').innerText = '#' + rank + '/169';
            document.getElementById('hand-tier').innerText = tier.name;
            document.getElementById('hand-tier').style.color = tier.color;
            document.getElementById('winrate-bar').style.width = winRate + '%';
            document.getElementById('winrate-value').innerText = winRate + '%';

            // 底池赔率
            if (currentState && myPlayer) {
                const currentRoundBets = currentState.players.reduce((s, p) => s + p.bet, 0);
                const totalPot = currentState.pot + currentRoundBets;
                const toCall = currentState.currentMaxBet - myPlayer.bet;
                if (toCall > 0 && totalPot > 0) {
                    const potOdds = Math.round(toCall / (totalPot + toCall) * 100);
                    document.getElementById('pot-odds-bar').style.width = Math.min(potOdds * 2, 100) + '%';
                    document.getElementById('pot-odds-marker').style.left = Math.min((100 - winRate) * 1.5, 95) + '%';
                } else {
                    document.getElementById('pot-odds-bar').style.width = '0%';
                    document.getElementById('pot-odds-marker').style.left = '0%';
                }
            }
        }

        // ========================================
        // 位置名称计算
        // ========================================
        function getPositionName(index, dealerSeat, numPlayers) {
            const offset = (index - dealerSeat + numPlayers) % numPlayers;
            if (numPlayers === 2) {
                return offset === 0 ? 'BTN' : 'BB';
            }
            if (numPlayers === 3) {
                return ['BTN', 'SB', 'BB'][offset];
            }
            if (numPlayers === 4) {
                return ['BTN', 'SB', 'BB', 'UTG'][offset];
            }
            if (numPlayers === 5) {
                return ['BTN', 'SB', 'BB', 'UTG', 'CO'][offset];
            }
            if (numPlayers === 6) {
                return ['BTN', 'SB', 'BB', 'UTG', 'MP', 'CO'][offset];
            }
            if (numPlayers === 7) {
                return ['BTN', 'SB', 'BB', 'UTG', 'MP', 'HJ', 'CO'][offset];
            }
            if (numPlayers === 8) {
                return ['BTN', 'SB', 'BB', 'UTG', 'UTG+1', 'LJ', 'HJ', 'CO'][offset];
            }
            return ['BTN', 'SB', 'BB', 'UTG', 'UTG+1', 'UTG+2', 'LJ', 'HJ', 'CO'][offset];
        }

        function getPositionClass(posName) {
            const map = {
                'BTN': 'pos-btn', 'SB': 'pos-sb', 'BB': 'pos-bb',
                'UTG': 'pos-utg', 'UTG+1': 'pos-utg', 'UTG+2': 'pos-utg',
                'MP': 'pos-mp', 'LJ': 'pos-mp', 'HJ': 'pos-hj', 'CO': 'pos-co'
            };
            return map[posName] || 'pos-utg';
        }

        function getSeatTemplate(numPlayers) {
            const templates = {
                2: [0, 1],
                3: [0, 3, 5],
                4: [0, 2, 5, 7],
                5: [0, 2, 4, 5, 7],
                6: [0, 1, 3, 5, 7, 8],
                7: [0, 1, 2, 4, 5, 7, 8],
                8: [0, 1, 2, 3, 5, 6, 7, 8],
                9: [0, 1, 2, 3, 4, 5, 6, 7, 8]
            };
            return templates[numPlayers] || templates[9];
        }

        function getSeatAnchorIndex(numPlayers) {
            const template = getSeatTemplate(numPlayers);
            const anchorByBottomCenter = template.indexOf(5);
            if (anchorByBottomCenter >= 0) return anchorByBottomCenter;
            return Math.floor(template.length / 2);
        }

        function getVisualSeatIndex(playerIndex, numPlayers, mySeatIndex) {
            const seatTemplate = getSeatTemplate(numPlayers);
            const anchorIndex = getSeatAnchorIndex(numPlayers);
            const safeMySeat = mySeatIndex >= 0 ? mySeatIndex : 0;
            const relativeOffset = (playerIndex - safeMySeat + numPlayers) % numPlayers;
            const visualOrderIndex = (anchorIndex + relativeOffset) % numPlayers;
            return seatTemplate[visualOrderIndex];
        }

        function getSeatCoordinates(isMobile = false) {
            if (isMobile) {
                return {
                    0: { x: 50, y: -18 },
                    1: { x: 76, y: -8 },
                    2: { x: 92, y: 16 },
                    3: { x: 90, y: 43 },
                    4: { x: 74, y: 82 },
                    5: { x: 50, y: 100 },
                    6: { x: 26, y: 82 },
                    7: { x: 10, y: 43 },
                    8: { x: 8, y: 16 }
                };
            }
            return {
                0: { x: 50, y: -8 },
                1: { x: 68, y: 2 },
                2: { x: 85, y: 14 },
                3: { x: 90, y: 40 },
                4: { x: 78, y: 78 },
                5: { x: 50, y: 94 },
                6: { x: 22, y: 78 },
                7: { x: 10, y: 40 },
                8: { x: 15, y: 14 }
            };
        }

        function getBetCoordinates(isMobile = false) {
            if (isMobile) {
                return {
                    0: { x: 50, y: 18 },
                    1: { x: 66, y: 22 },
                    2: { x: 76, y: 32 },
                    3: { x: 76, y: 50 },
                    4: { x: 64, y: 66 },
                    5: { x: 50, y: 72 },
                    6: { x: 36, y: 66 },
                    7: { x: 24, y: 50 },
                    8: { x: 24, y: 32 }
                };
            }
            return {
                0: { x: 50, y: 18 },
                1: { x: 63, y: 22 },
                2: { x: 74, y: 30 },
                3: { x: 76, y: 48 },
                4: { x: 64, y: 64 },
                5: { x: 50, y: 70 },
                6: { x: 36, y: 64 },
                7: { x: 24, y: 48 },
                8: { x: 26, y: 30 }
            };
        }

        function getPlayerSeatStyle(seatIndex) {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            const points = getSeatCoordinates(isMobile);
            const p = points[seatIndex] || points[0];
            return `top:${p.y}%;left:${p.x}%;transform:translate(-50%, -50%);`;
        }

        function getBetSeatStyle(seatIndex) {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            const points = getBetCoordinates(isMobile);
            const p = points[seatIndex] || points[0];
            return `top:${p.y}%;left:${p.x}%;right:auto;bottom:auto;transform:translate(-50%, -50%);`;
        }

        // ========================================
        // 卡牌渲染
        // ========================================
        function renderCard(cardCode, options = {}) {
            const suit = cardCode.slice(-1);
            const rank = cardCode.slice(0, -1);
            const isRed = (suit === 'h' || suit === 'd');
            const suitIcons = { 's': '♠', 'h': '♥', 'd': '♦', 'c': '♣' };
            const displayRank = rank === 'T' ? '10' : rank;
            const colorClass = isRed ? 'red' : 'black';
            const extraClass = options.isMine ? ' my-card' : '';

            return `<span class="card ${colorClass}${extraClass}" data-code="${cardCode}">
                <span class="card-rank">${displayRank}</span>
                <span class="card-suit">${suitIcons[suit]}</span>
            </span>`;
        }

        function renderCardBack() {
            return '<span class="card card-back"></span>';
        }

        function renderCardPlaceholder() {
            return '<span class="card card-placeholder"></span>';
        }

        // ========================================
        // 核心：状态更新
        // ========================================
        let prevStage = 'waiting';

        socket.on('update_state', (state) => {
            currentState = state;
            myPlayer = state.players.find(p => p.id === myId);

            // 检测新局开始 - 清除结算画面
            if (state.stage === 'preflop' && prevStage !== 'preflop') {
                handCount++;
                document.getElementById('hand-number').innerText = handCount;
                currentWinners = null;
                removeWinnerOverlay();

                // 借款统计：仅在进入新一局(preflop)时检测一次
                state.players.forEach(p => {
                    if (playerLoanCount[p.id] == null) {
                        playerLoanCount[p.id] = 0;
                    }
                    const prevChips = playerPrevChips[p.id];
                    if (prevChips != null && prevChips <= 0 && p.chips > 0) {
                        playerLoanCount[p.id] += 1;
                    }
                });
            }
            
            // 回到等待状态 - 清除结算画面
            if (state.stage === 'waiting' && prevStage !== 'waiting') {
                currentWinners = null;
                removeWinnerOverlay();
            }
            
            // 任何阶段变化都尝试清除结算画面（除了showdown）
            if (state.stage !== 'showdown' && prevStage === 'showdown') {
                removeWinnerOverlay();
            }
            
            prevStage = state.stage;

            // 更新标题
            document.getElementById('table-title').innerText = state.players.length + '人桌';

            // 底池
            const currentRoundBets = state.players.reduce((sum, p) => sum + p.bet, 0);
            const totalPot = state.pot + currentRoundBets;
            document.getElementById('pot-num').innerText = totalPot;

            // 公共牌
            const commDiv = document.getElementById('community-cards');
            let commHtml = '';
            for (let i = 0; i < 5; i++) {
                if (i < state.communityCards.length) {
                    commHtml += renderCard(state.communityCards[i]);
                } else {
                    commHtml += renderCardPlaceholder();
                }
            }
            commDiv.innerHTML = commHtml;

            // 开始按钮
            const startBtn = document.getElementById('start-game-btn');
            const startContainer = document.getElementById('start-container');
            if (state.stage === 'waiting') {
                startContainer.style.display = 'block';
                if (myPlayer && myPlayer.isHost) {
                    startBtn.disabled = false;
                    startBtn.innerText = '🎮 开始游戏';
                } else {
                    startBtn.disabled = true;
                    startBtn.innerText = '等待房主开始';
                }
            } else {
                startContainer.style.display = 'none';
            }

            // 渲染玩家
            renderPlayers(state);

            // AI面板
            updateAIPanel();

            // 操作面板
            updateActionPanel(state);

            // 赢牌效果
            if (currentWinners) {
                applyWinningEffects(currentWinners);
            }

            // 更新筹码快照（供下一次进入preflop时做借款检测）
            const currentIds = new Set(state.players.map(p => p.id));
            state.players.forEach(p => {
                playerPrevChips[p.id] = p.chips;
                if (playerLoanCount[p.id] == null) {
                    playerLoanCount[p.id] = 0;
                }
            });
            Object.keys(playerPrevChips).forEach(id => {
                if (!currentIds.has(id)) delete playerPrevChips[id];
            });
            Object.keys(playerLoanCount).forEach(id => {
                if (!currentIds.has(id)) delete playerLoanCount[id];
            });
        });

        // ========================================
        // 渲染玩家
        // ========================================
        function renderPlayers(state) {
            const pArea = document.getElementById('players-area');
            const betArea = document.getElementById('bet-chips-area');
            const pokerTable = document.getElementById('poker-table');
            const isCrowded = state.players.length >= 7;
            pArea.innerHTML = '';
            betArea.innerHTML = '';
            pArea.className = `players-${state.players.length}${isCrowded ? ' players-crowded' : ''}`;
            pokerTable.className = `poker-table table-players-${state.players.length}${isCrowded ? ' table-crowded' : ''}`;

            const mySeatIndex = state.players.findIndex(player => player.id === myId);

            state.players.forEach((p, index) => {
                const isMe = p.id === myId;
                const isTurn = index === state.activeSeat && state.stage !== 'waiting' && state.stage !== 'showdown';
                const posName = getPositionName(index, state.dealerSeat, state.players.length);
                const posClass = getPositionClass(posName);
                const visualSeatIndex = getVisualSeatIndex(index, state.players.length, mySeatIndex);

                // 初始化借款计数（如果是新玩家）
                if (playerLoanCount[p.id] == null) {
                    playerLoanCount[p.id] = 0;
                }

                // 手牌
                let cardsHtml = '';
                if (p.hand && p.hand.length > 0) {
                    if (isMe || state.stage === 'showdown' || currentWinners) {
                        cardsHtml = p.hand.map(c => renderCard(c, { isMine: isMe })).join('');
                    } else {
                        cardsHtml = renderCardBack() + renderCardBack();
                    }
                }

                // 操作标签
                let actionHtml = '';
                if (p.folded) {
                    actionHtml = '<div class="p-action fold-action">弃牌</div>';
                } else if (p.lastAction === 'allin' || (p.chips === 0 && p.bet > 0)) {
                    actionHtml = '<div class="p-action allin-action">ALL IN</div>';
                } else if (p.lastAction && state.stage !== 'waiting') {
                    const actionMap = {
                        'check': '<div class="p-action check-action">过牌</div>',
                        'call': '<div class="p-action call-action">跟注</div>',
                        'raise': '<div class="p-action raise-action">加注</div>'
                    };
                    actionHtml = actionMap[p.lastAction] || '';
                }

                // 弃牌标记（在卡片上方）
                let foldLabel = '';
                if (p.folded && state.stage !== 'waiting') {
                    foldLabel = '<div class="fold-label"><span class="fold-x">✕</span> 已弃牌</div>';
                }

                // 行动中标记
                let turnHtml = '';
                if (isTurn && !p.folded) {
                    turnHtml = `<div class="turn-indicator">
                        <span class="turn-label">🎯 行动中</span>
                        <span class="turn-timer" id="timer-${index}">--</span>
                    </div>`;
                }

                const wrapperHtml = `
                    <div class="player-wrapper" style="${getPlayerSeatStyle(visualSeatIndex)}" data-seat="${visualSeatIndex}" data-player-index="${index}">
                        ${foldLabel}
                        <div class="player-box ${isTurn ? 'active-turn' : ''} ${p.folded ? 'folded' : ''} ${isMe ? 'is-me' : ''}">
                            <div class="player-avatar">${p.isHost ? '👑' : '🎮'}</div>
                            <div class="player-info">
                                <div class="p-name-row">
                                    <span class="p-name">${p.name}${isMe ? '' : ''}</span>
                                </div>
                                <div class="p-bottom-row">
                                    <span class="position-badge ${posClass}">${posName}</span>
                                    <span class="p-chips">${p.chips}</span>
                                    <span class="p-loan">借款 ${playerLoanCount[p.id]} 次</span>
                                </div>
                                ${actionHtml}
                            </div>
                            <div class="player-cards">${cardsHtml}</div>
                        </div>
                        ${turnHtml}
                    </div>
                `;
                pArea.innerHTML += wrapperHtml;

                // 下注筹码
                if (p.bet > 0) {
                    betArea.innerHTML += `
                        <div class="bet-chip" style="${getBetSeatStyle(visualSeatIndex)}">
                            <div class="chip-icon">$</div>
                            <span class="chip-amount">${p.bet}</span>
                        </div>
                    `;
                }
            });

            // 启动行动计时器
            startTurnTimer(state);
        }

        // ========================================
        // 行动计时器
        // ========================================
        function startTurnTimer(state) {
            if (turnTimer) { clearInterval(turnTimer); turnTimer = null; }
            if (state.stage === 'waiting' || state.stage === 'showdown') return;

            const activeIdx = state.activeSeat;
            const timerEl = document.getElementById('timer-' + activeIdx);
            if (!timerEl) return;

            turnTimeLeft = 30;
            timerEl.innerText = turnTimeLeft + 's';
            let timeoutActionSent = false;

            turnTimer = setInterval(() => {
                turnTimeLeft--;
                const el = document.getElementById('timer-' + activeIdx);
                if (el) {
                    el.innerText = turnTimeLeft + 's';
                    if (turnTimeLeft <= 5) el.style.color = '#ef4444';
                }
                if (turnTimeLeft <= 0) {
                    clearInterval(turnTimer);
                    turnTimer = null;

                    if (timeoutActionSent || !currentState) return;
                    if (currentState.stage === 'waiting' || currentState.stage === 'showdown') return;

                    const stillActivePlayer = currentState.players[currentState.activeSeat];
                    const isMyTurn = stillActivePlayer && stillActivePlayer.id === myId;
                    if (isMyTurn && !myPlayer?.folded) {
                        timeoutActionSent = true;
                        socket.emit('action', { type: 'fold' });
                    }
                }
            }, 1000);
        }

        // ========================================
        // 操作面板更新
        // ========================================
        function updateActionPanel(state) {
            const actionContent = document.getElementById('action-content');
            const isMyTurn = myPlayer && state.players[state.activeSeat]?.id === myId && !myPlayer.folded;

            // 始终显示操作面板但根据状态禁用
            const btns = document.querySelectorAll('.action-btn, .quick-btn');
            const slider = document.getElementById('raise-slider');
            const betInput = document.getElementById('bet-input');

            if (!isMyTurn || state.stage === 'waiting' || state.stage === 'showdown') {
                btns.forEach(b => b.disabled = true);
                slider.disabled = true;
                betInput.disabled = true;
                actionContent.style.opacity = '0.5';
            } else {
                btns.forEach(b => b.disabled = false);
                slider.disabled = false;
                betInput.disabled = false;
                actionContent.style.opacity = '1';
                updateControlLogic(myPlayer, state);
            }

            // 有效积分
            if (myPlayer) {
                document.getElementById('effective-stack').innerText = '有效积分: ' + myPlayer.chips;
            }
        }

        function updateControlLogic(me, state) {
            const maxBet = state.currentMaxBet;
            const diff = maxBet - me.bet;
            const minRaise = state.minRaise || state.bigBlind || 20;
            const minBetValue = maxBet + minRaise;
            const maxBetValue = me.chips + me.bet;
            const bb = state.bigBlind || 20;
            const canRaise = maxBetValue >= minBetValue;

            // 跟注/过牌按钮
            const callBtn = document.getElementById('btn-call-check');
            const callText = document.getElementById('call-amount-text');
            if (diff > 0) {
                if (me.chips <= diff) {
                    callBtn.querySelector('.btn-sub')?.remove;
                    callBtn.innerHTML = 'All-in<span class="btn-sub">' + me.chips + '</span>';
                    callBtn.className = 'action-btn btn-call';
                    callBtn.dataset.action = 'call';
                } else {
                    callBtn.innerHTML = '跟注<span class="btn-sub">' + diff + '</span>';
                    callBtn.className = 'action-btn btn-call';
                    callBtn.dataset.action = 'call';
                }
            } else {
                callBtn.innerHTML = '过牌';
                callBtn.className = 'action-btn btn-call';
                callBtn.dataset.action = 'check';
            }

            // 下注/加注按钮
            const raiseBtn = document.getElementById('btn-raise');
            const slider = document.getElementById('raise-slider');
            slider.min = canRaise ? minBetValue : maxBetValue;
            slider.max = maxBetValue;
            if (parseInt(slider.value) < parseInt(slider.min)) slider.value = slider.min;

            updateBetFromSlider();

            raiseBtn.disabled = !canRaise;
            slider.disabled = !canRaise;
            const nonAllinQuickBtns = document.querySelectorAll('.quick-btn:not(.allin)');
            nonAllinQuickBtns.forEach(button => button.disabled = !canRaise);

            const allinBtn = document.getElementById('btn-allin');
            const allinQuickBtn = document.querySelector('.quick-btn.allin');
            const canAllInRaise = maxBetValue > maxBet;
            allinBtn.disabled = !canAllInRaise;
            if (allinQuickBtn) allinQuickBtn.disabled = !canAllInRaise;

            // 全下金额
            allinBtn.innerHTML = '全下<span class="btn-sub">' + maxBetValue + '</span>';

            // 范围显示
            document.getElementById('bet-range').innerText = canRaise
                ? ('范围: ' + minBetValue + ' - ' + maxBetValue)
                : ('当前无法满足最小加注（最小 ' + minBetValue + '）');
        }

        function updateBetFromSlider() {
            const slider = document.getElementById('raise-slider');
            const input = document.getElementById('bet-input');
            const bbDisplay = document.getElementById('bb-display');
            const raiseBtn = document.getElementById('btn-raise');
            const val = parseInt(slider.value);
            const bb = (currentState && currentState.bigBlind) || 20;

            input.value = val;
            bbDisplay.innerText = '(' + (val / bb).toFixed(1) + ' BB)';
            raiseBtn.innerHTML = '下注<span class="btn-sub">' + val + '</span>';
        }

        function updateSliderFromInput() {
            const slider = document.getElementById('raise-slider');
            const input = document.getElementById('bet-input');
            const bbDisplay = document.getElementById('bb-display');
            const raiseBtn = document.getElementById('btn-raise');
            let val = parseInt(input.value) || 0;
            const bb = (currentState && currentState.bigBlind) || 20;

            val = Math.max(parseInt(slider.min), Math.min(parseInt(slider.max), val));
            slider.value = val;
            bbDisplay.innerText = '(' + (val / bb).toFixed(1) + ' BB)';
            raiseBtn.innerHTML = '下注<span class="btn-sub">' + val + '</span>';
        }

        // ========================================
        // 快捷加注
        // ========================================
        function quickRaise(type) {
            if (!myPlayer || !currentState) return;

            const currentRoundBets = currentState.players.reduce((sum, p) => sum + p.bet, 0);
            const totalPot = currentState.pot + currentRoundBets;
            const maxBet = currentState.currentMaxBet;
            const minRaise = currentState.minRaise || currentState.bigBlind || 20;
            const bb = currentState.bigBlind || 20;
            const myBet = myPlayer.bet;
            const myChips = myPlayer.chips;
            const minBetValue = maxBet + minRaise;
            const maxBetValue = myBet + myChips;
            const canRaise = maxBetValue >= minBetValue;
            let targetBet = 0;

            if (type !== 'allin' && !canRaise) {
                return;
            }

            switch (type) {
                case 'min':
                    targetBet = minBetValue;
                    break;
                case '3bb':
                    targetBet = Math.max(minBetValue, bb * 3);
                    break;
                case '4bb':
                    targetBet = Math.max(minBetValue, bb * 4);
                    break;
                case '5bb':
                    targetBet = Math.max(minBetValue, bb * 5);
                    break;
                case 'half':
                    targetBet = maxBet + Math.floor(totalPot / 2);
                    break;
                case 'pot':
                    targetBet = maxBet + totalPot;
                    break;
                case 'allin':
                    targetBet = maxBetValue;
                    break;
            }

            targetBet = Math.max(minBetValue, Math.min(targetBet, maxBetValue));
            if (type === 'allin') {
                targetBet = maxBetValue;
            }

            const slider = document.getElementById('raise-slider');
            slider.value = targetBet;
            updateBetFromSlider();

            if (type === 'allin') {
                socket.emit('action', { type: 'raise', amount: targetBet });
            }
        }

        // ========================================
        // 操作按钮
        // ========================================
        function handleCallCheck() {
            const btn = document.getElementById('btn-call-check');
            socket.emit('action', { type: btn.dataset.action || 'check' });
        }

        function handleRaise() {
            const val = parseInt(document.getElementById('raise-slider').value);
            if (!val) return;
            socket.emit('action', { type: 'raise', amount: val });
        }

        function sendAction(type) {
            socket.emit('action', { type });
        }

        // ========================================
        // 顶部栏按钮
        // ========================================
        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pause-btn');
            btn.innerText = isPaused ? '▶ 继续' : '⏸ 暂停';
            socket.emit('toggle_pause');
        }

        function endGame() {
            if (confirm('确定要结束当前游戏吗？')) {
                socket.emit('end_game');
            }
        }

        // ========================================
        // 系统消息
        // ========================================
        socket.on('system_msg', (msg) => {
            const logDiv = document.getElementById('logs');
            const time = new Date().toTimeString().split(' ')[0];
            logDiv.innerHTML = `<div><span style="color:#666">[${time}]</span> ${msg}</div>` + logDiv.innerHTML;
        });

        // ========================================
        // 游戏结束
        // ========================================
        socket.on('game_over', (winners) => {
            showWinnerOverlay(winners.join('<br>'), []);
        });

        socket.on('game_over_details', (winnerInfo) => {
            currentWinners = winnerInfo;
            const msgLines = winnerInfo.map(w =>
                `🏆 ${w.name}<br><span style="font-size:14px;color:#94a3b8;">${w.desc || ''}</span>`
            );
            showWinnerOverlay(msgLines.join('<br><br>'), winnerInfo);
            applyWinningEffects(winnerInfo);
        });

        function showWinnerOverlay(msgHtml) {
            // 先移除旧的结算画面
            removeWinnerOverlay();
            
            const div = document.createElement('div');
            div.id = 'winner-overlay';
            div.style.cssText = `
                position: fixed; top: 35%; left: 50%; transform: translate(-50%, -50%);
                background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
                border: 2px solid var(--accent); padding: 30px 50px;
                text-align: center; border-radius: 16px; z-index: 2000; min-width: 280px;
                box-shadow: 0 0 60px rgba(89, 211, 255, 0.3);
                animation: popin 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            `;
            div.innerHTML = `
                <h2 style="color:var(--accent); margin:0 0 15px 0; font-size:22px;">🎉 结算 🎉</h2>
                <div style="font-size:17px; line-height:1.8;">${msgHtml}</div>
                <div style="margin-top:18px; font-size:12px; color:#64748b;">下一局即将开始...</div>
            `;
            document.body.appendChild(div);

            if (!document.getElementById('popin-style')) {
                const style = document.createElement('style');
                style.id = 'popin-style';
                style.innerHTML = `@keyframes popin { from { transform: translate(-50%, -50%) scale(0.3); opacity:0;} to { transform: translate(-50%, -50%) scale(1); opacity:1;} }`;
                document.head.appendChild(style);
            }
            
            // 5秒后自动移除
            setTimeout(() => {
                removeWinnerOverlay();
            }, 5000);
        }
        
        function removeWinnerOverlay() {
            const overlay = document.getElementById('winner-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function applyWinningEffects(winnerInfo) {
            if (!winnerInfo) return;
            const allCards = Array.from(document.querySelectorAll('.card'));
            allCards.forEach(c => c.classList.remove('winning-card'));
            winnerInfo.forEach(w => {
                const winningCodes = w.cards || [];
                allCards.forEach(cardEl => {
                    const code = cardEl.dataset.code;
                    if (winningCodes.includes(code)) {
                        cardEl.classList.add('winning-card');
                    }
                });
            });
            
            // 10秒后清除获胜特效
            setTimeout(() => {
                const cards = Array.from(document.querySelectorAll('.card'));
                cards.forEach(c => c.classList.remove('winning-card'));
            }, 10000);
        }

        // ========================================
        // 聊天功能
        // ========================================
        socket.on('chat_msg', (data) => {
            const chatDiv = document.getElementById('chat-messages');
            chatDiv.innerHTML += `
                <div class="chat-msg">
                    <span class="chat-name">${data.name}:</span>
                    <span class="chat-text">${escapeHtml(data.msg)}</span>
                    <span class="chat-time">${data.time}</span>
                </div>
            `;
            chatDiv.scrollTop = chatDiv.scrollHeight;
        });

        socket.on('emoji', (data) => {
            showEmojiAtSeat(data.seat, data.emoji);
        });

        function sendChatMsg() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;
            socket.emit('chat_msg', msg);
            input.value = '';
        }

        function toggleChat() {
            const popup = document.getElementById('chat-popup');
            popup.classList.toggle('open');
        }

        const EMOJI_LIST = ['😀','😎','🤔','😭','😡','🤯','🥳','🤣','😴','🤩','🥶','🙌','👍','👎','🔥','💰','❤️','🎉'];

        function initEmojiBar() {
            const bar = document.getElementById('emoji-bar');
            if (!bar) return;
            bar.innerHTML = EMOJI_LIST.map(e => `<button class="emoji-btn" onclick="sendEmoji('${e}')">${e}</button>`).join('');
        }

        function sendEmoji(emoji) {
            socket.emit('emoji', emoji);
        }

        function showEmojiAtSeat(seat, emoji) {
            const target = document.querySelector(`.player-wrapper[data-player-index="${seat}"]`) || document.getElementById('poker-table');
            if (!target) return;
            const el = document.createElement('div');
            el.className = 'emoji-float';
            el.textContent = emoji;
            target.appendChild(el);
            setTimeout(() => {
                if (el.parentNode) el.parentNode.removeChild(el);
            }, 1700);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        initEmojiBar();

        // AI toggle
        document.getElementById('ai-toggle')?.addEventListener('change', updateAIPanel);
    </script>
</body>
</html>

