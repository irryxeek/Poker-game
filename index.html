<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾·å·æ‰‘å…‹ Pro</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: #205c36; /* ç»å…¸çš„ç‰Œæ¡Œç»¿ */
            color: white; 
            text-align: center; 
            margin: 0; 
            padding-bottom: 80px; /* ç»™åº•éƒ¨æ“ä½œæ ç•™ç©ºé—´ */
            overflow-x: hidden;
        }

        /* --- ç™»å½•é¡µ --- */
        #login-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; background: rgba(0,0,0,0.8);
        }
        input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; text-align: center;}
        .btn-start { padding: 10px 20px; font-size: 18px; background: #f1c40f; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer; color: #333; font-weight: bold;}

        /* --- æ¸¸æˆåŒº --- */
        .info-board { background: rgba(0,0,0,0.3); padding: 10px; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .pot-text { font-size: 24px; color: #f1c40f; font-weight: bold; text-shadow: 1px 1px 2px black;}
        
        /* å…¬å…±ç‰Œ */
        #community-cards { min-height: 60px; margin: 10px 0; display: flex; justify-content: center; gap: 5px; }
        
        /* æ‰‘å…‹ç‰Œé€šç”¨æ ·å¼ */
        .card { 
            background: white; color: black; 
            padding: 6px 10px; border-radius: 6px; 
            font-weight: bold; font-size: 18px; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5); 
            display: inline-block; min-width: 20px;
        }

        /* --- ç©å®¶åŒºåŸŸ --- */
        #players-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px;}
        
        .player { 
            position: relative;
            border: 2px solid rgba(255,255,255,0.1); 
            background: rgba(0,0,0,0.4); 
            padding: 10px; border-radius: 10px; 
            width: 42%; /* æ‰‹æœºä¸Šä¸€è¡Œä¸¤ä¸ª */
            max-width: 150px;
            transition: all 0.3s;
        }
        
        /* çŠ¶æ€ä¿®é¥° */
        .active-turn { border-color: #f1c40f; box-shadow: 0 0 15px rgba(241, 196, 15, 0.6); background: rgba(241, 196, 15, 0.1); transform: scale(1.05); z-index: 10;}
        .folded { opacity: 0.5; filter: grayscale(100%); }
        .winner { border-color: #e74c3c; box-shadow: 0 0 20px #e74c3c; }

        /* åº„å®¶æŒ‰é’® (Dealer Button) */
        .dealer-btn { 
            position: absolute; top: -10px; right: -10px; 
            background: white; color: black; border: 2px solid orange; 
            width: 20px; height: 20px; line-height: 20px; 
            border-radius: 50%; font-size: 12px; font-weight: bold;
            box-shadow: 1px 1px 3px black;
        }

        /* ç©å®¶ä¿¡æ¯ç»†èŠ‚ */
        .p-name { font-weight: bold; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .p-chips { color: #2ecc71; font-size: 14px; margin: 2px 0; }
        .p-bet { background: rgba(0,0,0,0.3); border-radius: 10px; font-size: 12px; padding: 2px 8px; display: inline-block; margin-bottom: 5px; color: #ddd;}

        /* --- åº•éƒ¨æ“ä½œæ  --- */
        #controls-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(0,0,0,0.9); padding: 15px 10px; 
            box-sizing: border-box; 
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #444;
            z-index: 100;
        }
        
        /* æŒ‰é’®é€šç”¨ */
        .action-btn { padding: 12px 0; width: 30%; border-radius: 8px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; color: white;}
        .btn-fold { background: #e74c3c; } /* çº¢ */
        .btn-check { background: #3498db; } /* è“ */
        .btn-call { background: #2ecc71; } /* ç»¿ */
        .btn-raise { background: #f39c12; } /* æ©™ */

        /* åŠ æ³¨è¾“å…¥åŒº */
        .raise-group { display: flex; flex-direction: column; width: 30%; gap: 5px; }
        .raise-input { width: 100%; box-sizing: border-box; padding: 5px; border-radius: 4px; border: 1px solid #aaa; color: black; text-align: center; font-weight: bold;}

        /* åœ¨ style æ ‡ç­¾é‡Œå¢åŠ  */
        .winning-card {
            border: 2px solid #f1c40f !important; /* é‡‘è‰²è¾¹æ¡† */
            box-shadow: 0 0 10px #f1c40f !important; /* é‡‘è‰²å‘å…‰ */
            transform: translateY(-5px); /* ç¨å¾®ä¸Šæµ® */
            z-index: 100;
        }
        
        /* ç³»ç»Ÿæ¶ˆæ¯ */
        #logs { font-size: 12px; color: #aaa; max-height: 80px; overflow-y: auto; margin: 10px; text-align: left; background: rgba(0,0,0,0.2); padding: 5px;}
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color:#f1c40f; text-shadow: 2px 2px 0 #000;">å¾·å·æ‰‘å…‹</h1>
        <input type="text" id="nickname" placeholder="è¾“å…¥æ˜µç§° (ä¾‹å¦‚: èµŒç¥)">
        <button class="btn-start" onclick="joinGame()">å…¥åº§</button>
    </div>

    <div id="game-screen" style="display:none;">
        
        <div class="info-board">
            <div style="font-size: 12px; color: #ccc;">å½“å‰é˜¶æ®µ: <span id="stage-name" style="color:#fff; font-weight:bold;">ç­‰å¾…å¼€å§‹</span></div>
            <div class="pot-text">åº•æ± : <span id="pot-num">0</span></div>
            <div id="community-cards"></div>
        </div>

        <div id="players-area">
            </div>

        <div id="logs"></div>

        <div style="margin-top: 20px; opacity: 0.6;">
            <button onclick="socket.emit('start_game')" style="padding:5px 10px; background:#555; border:none; color:white; border-radius:4px;">ğŸ”„ é‡æ–°/å¼€å§‹æ¸¸æˆ</button>
        </div>

        <div id="controls-bar" style="display:none;">
            <button class="action-btn btn-fold" onclick="sendAction('fold')">å¼ƒç‰Œ</button>
            
            <button id="btn-call-check" class="action-btn btn-check" onclick="handleCallCheck()">è¿‡ç‰Œ</button>
            
            <div class="raise-group">
                <input type="number" id="raise-amount" class="raise-input" placeholder="æ•°é¢">
                <button class="action-btn btn-raise" style="width:100%; padding: 5px 0;" onclick="handleRaise()">åŠ æ³¨</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myId = null;
        let currentState = null; 
        let currentWinners = null; // ä¿å­˜æœ¬å±€è·èƒœä¿¡æ¯

        // --- åŸºç¡€è¿æ¥é€»è¾‘ ---
        socket.on('connect', () => { myId = socket.id; });

        function joinGame() {
            const name = document.getElementById('nickname').value;
            if(!name) return alert("è¯·è¾“å…¥æ˜µç§°");
            socket.emit('join', name);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
        }

        // --- æ ¸å¿ƒï¼šUI æ¸²æŸ“ ---
        socket.on('update_state', (state) => {
            currentState = state; // æ›´æ–°æœ¬åœ°ç¼“å­˜
            
            // å¦‚æœæ–°çš„ä¸€å±€å¼€å§‹äº†(preflop)ï¼Œæ¸…ç©ºä¸Šå±€èµ¢å®¶ä¿¡æ¯
            if (state.stage === 'preflop' || state.stage === 'waiting') {
                currentWinners = null;
                document.getElementById('winner-overlay')?.remove(); // ç§»é™¤ç»“ç®—å¼¹çª—
            }

            // 1. æ›´æ–°é¡¶éƒ¨ä¿¡æ¯
            document.getElementById('pot-num').innerText = state.pot;
            document.getElementById('stage-name').innerText = translateStage(state.stage);
            
            const commDiv = document.getElementById('community-cards');
            commDiv.innerHTML = state.communityCards.map(c => renderCard(c)).join('');

            // 2. æ¸²æŸ“æ‰€æœ‰ç©å®¶
            const pArea = document.getElementById('players-area');
            pArea.innerHTML = '';

            state.players.forEach((p, index) => {
                const isMe = p.id === myId;
                const isTurn = index === state.activeSeat; // æ˜¯å¦è½®åˆ°è¯¥äºº
                const isDealer = index === state.dealerSeat;

                // 2.1 æ¸²æŸ“æ‰‹ç‰Œ 
                // å¦‚æœæ˜¯ showdown é˜¶æ®µï¼Œä¸”æœåŠ¡å™¨å·²ç»ä¸‹å‘äº† winnerInfoï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿èƒ½çœ‹åˆ°æ‰€æœ‰æœªå¼ƒç‰Œç©å®¶çš„æ‰‹ç‰Œ
                // (Serverç«¯é€šå¸¸ä¼šåœ¨ showdown æ—¶æŠŠ hand å‘é€ç»™æ‰€æœ‰äºº)
                let handHtml = '';
                if (p.hand && p.hand.length > 0) {
                    // è‡ªå·±ã€æ‘Šç‰Œé˜¶æ®µã€æˆ–å·²ç»ç»“æŸ
                    if (isMe || state.stage === 'showdown' || currentWinners) {
                        handHtml = p.hand.map(c => renderCard(c, true)).join('');
                    } else {
                        handHtml = '<span class="card" style="background:#555; color:#ccc;">ğŸ‚ </span><span class="card" style="background:#555; color:#ccc;">ğŸ‚ </span>';
                    }
                } else {
                    handHtml = '<span style="font-size:12px; color:#aaa;">ç­‰å¾…ä¸­</span>';
                }

                // 2.2 æ„å»º HTML
                const playerHtml = `
                    <div class="player ${isTurn ? 'active-turn' : ''} ${p.folded ? 'folded' : ''}">
                        ${isDealer ? '<div class="dealer-btn">D</div>' : ''}
                        <div class="p-name">${p.name}</div>
                        <div class="p-chips">ğŸ’° ${p.chips}</div>
                        <div class="p-bet">æœ¬è½®ä¸‹æ³¨: ${p.bet}</div>
                        <div style="margin-top:5px;">${handHtml}</div>
                    </div>
                `;
                pArea.innerHTML += playerHtml;

                // 3. æ›´æ–°æ“ä½œæ çŠ¶æ€ (ä»…é’ˆå¯¹è‡ªå·±)
                if (isMe) {
                    const controls = document.getElementById('controls-bar');
                    if (isTurn) {
                        controls.style.display = 'flex'; 
                        updateButtonLogic(p, state.currentMaxBet);
                    } else {
                        controls.style.display = 'none';
                    }
                }
            });

            // å¦‚æœå¤„äºç»“ç®—çŠ¶æ€ï¼Œé‡æ–°åº”ç”¨é«˜äº® (é˜²æ­¢ render è¦†ç›–)
            if (currentWinners) {
                applyWinningEffects(currentWinners);
            }
        });

        // --- è¾…åŠ©é€»è¾‘ ---

        // æ¸²æŸ“å•å¼ æ‰‘å…‹ç‰Œ (å¢åŠ  data-code ä»¥ä¾¿æŸ¥æ‰¾)
        function renderCard(cardCode, isHand=false) {
            const suit = cardCode.slice(-1); 
            const rank = cardCode.slice(0, -1);
            const color = (suit === 'h' || suit === 'd') ? '#e74c3c' : 'black';
            const suitIcons = {'s':'â™ ', 'h':'â™¥', 'd':'â™¦', 'c':'â™£'};
            
            return `<span class="card" data-code="${cardCode}" style="color:${color}; ${isHand ? 'border:1px solid gold;' : ''}">
                ${rank}${suitIcons[suit]}
            </span>`;
        }

        // åŠ¨æ€æ›´æ–°æŒ‰é’® (Check è¿˜æ˜¯ Call?)
        function updateButtonLogic(me, maxBet) {
            const btn = document.getElementById('btn-call-check');
            const diff = maxBet - me.bet;
            
            // æ›´æ–°è¾“å…¥æ¡†é»˜è®¤å€¼ (æœ€å°åŠ æ³¨: å½“å‰æœ€å¤§æ³¨ + æœ€å°åŠ æ³¨é¢)
            // gameState.minRaise å­˜åœ¨ state ä¸­ (å¦‚æœæ²¡æœ‰ä¼ ï¼Œé»˜è®¤ 20)
            const minRaiseVal = currentState.minRaise || 20;
            const targetTotal = maxBet + minRaiseVal;
            
            const input = document.getElementById('raise-amount');
            // åªæœ‰å½“è¾“å…¥æ¡†æ²¡è¢«ç”¨æˆ·ä¿®æ”¹è¿‡æ—¶ï¼Œæ‰è‡ªåŠ¨æ›´æ–°å»ºè®®å€¼ï¼Œé˜²æ­¢ç”¨æˆ·è¾“å…¥ä¸€åŠè¢«è¦†ç›–
            if (document.activeElement !== input) {
                input.value = targetTotal; 
            }

            if (diff > 0) {
            
                // å¦‚æœæ˜¯ All-in (é’±ä¸å¤Ÿè·Ÿ)
                if (me.chips <= diff) {
                    btn.innerText = `All-in (${me.chips})`;
                    btn.className = "action-btn btn-raise"; // ç”¨çº¢è‰²æˆ–æ©™è‰²é†’ç›®
                    btn.dataset.action = "call"; // ä¾ç„¶æ˜¯ callé€»è¾‘
                } else {
                    // éœ€è¦è·Ÿæ³¨
                    btn.innerText = `è·Ÿæ³¨ ${diff}`;
                    btn.className = "action-btn btn-call";
                    btn.dataset.action = "call"; 
                }

            } else {
                // å¯ä»¥è¿‡ç‰Œ
                btn.innerText = "è¿‡ç‰Œ (Check)";
                btn.className = "action-btn btn-check";
                btn.dataset.action = "check";
            }
        }

        // --- æŒ‰é’®ç‚¹å‡»äº‹ä»¶ ---

        function handleCallCheck() {
            const btn = document.getElementById('btn-call-check');
            const action = btn.dataset.action; // 'call' or 'check'
            socket.emit('action', { type: action });
        }

        function handleRaise() {
            const val = document.getElementById('raise-amount').value;
            if (!val) return;
            socket.emit('action', { type: 'raise', amount: parseInt(val) });
        }

        function sendAction(type) {
            socket.emit('action', { type: type });
        }

        // --- æ¶ˆæ¯ä¸ç¿»è¯‘ ---

        socket.on('system_msg', (msg) => {
            const logDiv = document.getElementById('logs');
            const time = new Date().toTimeString().split(' ')[0];
            logDiv.innerHTML = `<div><span style="color:#aaa">[${time}]</span> ${msg}</div>` + logDiv.innerHTML;
        });

        socket.on('game_over', (winners) => {
            // ç®€å•èƒœåˆ©(å¼ƒç‰Œ)
            showWinnerOverlay(winners.join('\n'), []);
        });

        socket.on('game_over_details', (winnerInfo) => {
            currentWinners = winnerInfo; // ä¿å­˜ä¸‹æ¥ï¼Œrender æ—¶ä¼šç”¨åˆ°
            
            const msgLines = winnerInfo.map(w => `ğŸ† ${w.name} ${w.desc ? '('+w.desc+')' : ''} +${w.chips || ''}`);
            showWinnerOverlay(msgLines.join('<br>'), winnerInfo);
            
            applyWinningEffects(winnerInfo);
        });

        function showWinnerOverlay(msgHtml, winnerInfo) {
            // é¿å…é‡å¤åˆ›å»º
            if (document.getElementById('winner-overlay')) return;

            const div = document.createElement('div');
            div.id = 'winner-overlay';
            div.style.cssText = `
                position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.9); border: 2px solid gold; padding: 20px;
                text-align: center; border-radius: 10px; z-index: 2000; min-width: 200px;
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
                animation: popin 0.5s ease;
            `;
            div.innerHTML = `
                <h2 style="color:gold; margin:0 0 10px 0;">ğŸ‰ ç»“ç®— ğŸ‰</h2>
                <div style="font-size:18px; line-height:1.5;">${msgHtml}</div>
                <div style="margin-top:15px; font-size:12px; color:#aaa;">ç­‰å¾…å¼€å§‹ä¸‹ä¸€å±€...</div>
            `;
            document.body.appendChild(div);

            // å¢åŠ ç®€å•çš„ css åŠ¨ç”»
            const style = document.createElement('style');
            style.innerHTML = `@keyframes popin { from { transform: translate(-50%, -50%) scale(0.5); opacity:0;} to { transform: translate(-50%, -50%) scale(1); opacity:1;} }`;
            document.head.appendChild(style);
        }

        function applyWinningEffects(winnerInfo) {
            if (!winnerInfo) return;
            const allCards = Array.from(document.querySelectorAll('.card'));
            
            // 1. å…ˆç§»é™¤æ‰€æœ‰æ—§çš„é«˜äº®
            allCards.forEach(c => c.classList.remove('winning-card'));

            // 2. éå†èµ¢å®¶
            winnerInfo.forEach(w => {
                const winningCodes = w.cards || [];
                // 3. éå† DOM é‡Œçš„æ¯ä¸€å¼ ç‰Œ
                allCards.forEach(cardEl => {
                    const code = cardEl.dataset.code;
                    if (winningCodes.includes(code)) {
                        cardEl.classList.add('winning-card');
                    }
                });
            });
        }

        function translateStage(stage) {
            const map = {
                'waiting': 'ç­‰å¾…å¼€å§‹',
                'preflop': 'ç¿»ç‰Œå‰ (Pre-flop)',
                'flop': 'ç¿»ç‰Œåœˆ (Flop)',
                'turn': 'è½¬ç‰Œåœˆ (Turn)',
                'river': 'æ²³ç‰Œåœˆ (River)',
                'showdown': 'æ‘Šç‰Œç»“ç®—'
            };
            return map[stage] || stage;
        }
    </script>
</body>
</html>