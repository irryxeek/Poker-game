<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾·å·æ‰‘å…‹ Pro</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3f 50%, #1a472a 100%);
            color: white; 
            text-align: center; 
            margin: 0; 
            padding-bottom: 180px;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- ç™»å½•é¡µ --- */
        #login-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(20,60,40,0.9) 100%);
        }
        #login-screen h1 {
            font-size: 48px;
            background: linear-gradient(to bottom, #ffd700, #ffaa00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: none;
            margin-bottom: 30px;
        }
        input { 
            padding: 15px 20px; 
            border-radius: 25px; 
            border: 2px solid #f1c40f; 
            font-size: 18px; 
            text-align: center;
            background: rgba(255,255,255,0.1);
            color: white;
            width: 280px;
            outline: none;
        }
        input::placeholder { color: rgba(255,255,255,0.5); }
        .btn-start { 
            padding: 15px 50px; 
            font-size: 20px; 
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); 
            border: none; 
            border-radius: 25px; 
            margin-top: 20px; 
            cursor: pointer; 
            color: #333; 
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(241, 196, 15, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-start:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(241, 196, 15, 0.6); }

        /* --- æ¸¸æˆåŒº --- */
        .info-board { 
            background: linear-gradient(180deg, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.3) 100%); 
            padding: 15px; 
            margin-bottom: 10px; 
            border-bottom: 2px solid rgba(241, 196, 15, 0.3);
        }
        .stage-text { font-size: 14px; color: #aaa; margin-bottom: 5px; }
        .stage-name { color: #fff; font-weight: bold; background: rgba(241,196,15,0.2); padding: 3px 12px; border-radius: 12px; }
        .pot-text { font-size: 28px; color: #f1c40f; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin: 10px 0; }
        
        /* å…¬å…±ç‰Œ */
        #community-cards { 
            min-height: 70px; 
            margin: 15px auto; 
            display: flex; 
            justify-content: center; 
            gap: 8px;
            perspective: 1000px;
        }
        
        /* æ‰‘å…‹ç‰Œé€šç”¨æ ·å¼ */
        .card { 
            background: linear-gradient(135deg, #fff 0%, #f5f5f5 100%);
            color: black; 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-weight: bold; 
            font-size: 20px; 
            box-shadow: 3px 3px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.8); 
            display: inline-block; 
            min-width: 35px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover { transform: translateY(-3px); }

        /* --- ç©å®¶åŒºåŸŸ --- */
        #players-area { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 12px; 
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .player { 
            position: relative;
            border: 2px solid rgba(255,255,255,0.15); 
            background: linear-gradient(180deg, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.3) 100%); 
            padding: 12px; 
            border-radius: 15px; 
            width: 45%;
            max-width: 160px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        
        /* çŠ¶æ€ä¿®é¥° */
        .active-turn { 
            border-color: #f1c40f; 
            box-shadow: 0 0 25px rgba(241, 196, 15, 0.7), inset 0 0 15px rgba(241, 196, 15, 0.1); 
            background: linear-gradient(180deg, rgba(241, 196, 15, 0.15) 0%, rgba(0,0,0,0.4) 100%); 
            transform: scale(1.05); 
            z-index: 10;
        }
        .folded { opacity: 0.4; filter: grayscale(100%); }
        .winner { border-color: #e74c3c; box-shadow: 0 0 25px #e74c3c; }
        .is-host::before {
            content: 'ğŸ‘‘';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
        }

        /* åº„å®¶æŒ‰é’® (Dealer Button) */
        .dealer-btn { 
            position: absolute; top: -8px; right: -8px; 
            background: linear-gradient(135deg, #fff 0%, #ddd 100%); 
            color: #333; 
            border: 3px solid #f39c12; 
            width: 24px; height: 24px; line-height: 18px; 
            border-radius: 50%; font-size: 12px; font-weight: bold;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }

        /* ç©å®¶ä¿¡æ¯ç»†èŠ‚ */
        .p-name { font-weight: bold; font-size: 14px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-bottom: 3px; }
        .p-chips { color: #2ecc71; font-size: 15px; font-weight: bold; margin: 4px 0; }
        .p-bet { 
            background: rgba(241, 196, 15, 0.2); 
            border-radius: 12px; 
            font-size: 12px; 
            padding: 3px 10px; 
            display: inline-block; 
            margin-bottom: 6px; 
            color: #f1c40f;
            border: 1px solid rgba(241, 196, 15, 0.3);
        }
        .p-bet.has-bet {
            background: rgba(241, 196, 15, 0.4);
            border: 2px solid #f1c40f;
            font-weight: bold;
            animation: pulse-bet 1.5s ease-in-out infinite;
        }
        @keyframes pulse-bet {
            0%, 100% { box-shadow: 0 0 5px rgba(241, 196, 15, 0.5); }
            50% { box-shadow: 0 0 15px rgba(241, 196, 15, 0.8); }
        }
        .p-action {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 4px;
            display: inline-block;
            font-weight: bold;
        }
        .p-action.fold {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.5);
        }
        .p-action.check {
            background: rgba(52, 152, 219, 0.3);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.5);
        }
        .p-action.call {
            background: rgba(46, 204, 113, 0.3);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.5);
        }
        .p-action.raise {
            background: rgba(243, 156, 18, 0.3);
            color: #f39c12;
            border: 1px solid rgba(243, 156, 18, 0.5);
        }
        .p-action.allin {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.4) 0%, rgba(192, 57, 43, 0.4) 100%);
            color: #fff;
            border: 2px solid #e74c3c;
            animation: pulse-allin 1s ease-in-out infinite;
        }
        @keyframes pulse-allin {
            0%, 100% { box-shadow: 0 0 5px rgba(231, 76, 60, 0.5); }
            50% { box-shadow: 0 0 15px rgba(231, 76, 60, 1); }
        }
        .p-status { font-size: 11px; color: #aaa; margin-top: 3px; }

        /* --- åº•éƒ¨æ“ä½œæ  --- */
        #controls-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: linear-gradient(180deg, rgba(20,20,20,0.98) 0%, rgba(0,0,0,0.98) 100%); 
            padding: 12px 10px 20px 10px; 
            display: none;
            flex-direction: column;
            gap: 10px;
            border-top: 2px solid #333;
            z-index: 100;
        }
        
        /* å¿«æ·åŠ æ³¨æŒ‰é’®è¡Œ */
        .quick-raise-row {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            padding: 0 5px;
        }
        .quick-btn {
            flex: 1;
            padding: 10px 5px;
            border-radius: 8px;
            border: 2px solid #555;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-btn:hover, .quick-btn:active {
            background: rgba(241, 196, 15, 0.2);
            border-color: #f1c40f;
        }
        .quick-btn.allin {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            border-color: #e74c3c;
            color: #fff;
        }
        
        /* åŠ æ³¨æ»‘å—è¡Œ */
        .raise-slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 10px;
        }
        .raise-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, #2ecc71 0%, #f1c40f 50%, #e74c3c 100%);
            outline: none;
        }
        .raise-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #f1c40f;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .raise-amount-display {
            min-width: 70px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border: 2px solid #f1c40f;
            border-radius: 8px;
            color: #f1c40f;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
        }

        /* ä¸»æ“ä½œæŒ‰é’®è¡Œ */
        .action-row {
            display: flex;
            justify-content: space-around;
            gap: 8px;
            padding: 0 5px;
        }
        
        .action-btn { 
            flex: 1;
            padding: 14px 0; 
            border-radius: 10px; 
            border: none; 
            font-weight: bold; 
            font-size: 16px; 
            cursor: pointer; 
            color: white;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .action-btn:active { transform: scale(0.95); }
        
        .btn-fold { background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%); }
        .btn-check { background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); }
        .btn-call { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .btn-raise { background: linear-gradient(135deg, #d35400 0%, #f39c12 100%); box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3); }

        /* èµ¢ç‰Œé«˜äº® */
        .winning-card {
            border: 3px solid #f1c40f !important;
            box-shadow: 0 0 15px #f1c40f, 0 0 30px rgba(241,196,15,0.5) !important;
            transform: translateY(-8px) scale(1.05);
            z-index: 100;
            animation: glow 1s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 15px #f1c40f, 0 0 30px rgba(241,196,15,0.5); }
            to { box-shadow: 0 0 25px #f1c40f, 0 0 50px rgba(241,196,15,0.8); }
        }
        
        /* ç³»ç»Ÿæ¶ˆæ¯ */
        #logs { 
            font-size: 12px; 
            color: #aaa; 
            max-height: 60px; 
            overflow-y: auto; 
            margin: 10px 15px; 
            text-align: left; 
            background: rgba(0,0,0,0.3); 
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        #logs::-webkit-scrollbar { width: 4px; }
        #logs::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }

        /* èŠå¤©åŒºåŸŸ */
        .chat-container {
            margin: 10px 15px;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }
        .chat-header {
            background: rgba(0,0,0,0.3);
            padding: 8px 12px;
            font-size: 13px;
            font-weight: bold;
            color: #f1c40f;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .chat-toggle {
            font-size: 12px;
            color: #aaa;
        }
        #chat-messages {
            max-height: 120px;
            overflow-y: auto;
            padding: 8px 12px;
            font-size: 13px;
            text-align: left;
        }
        #chat-messages::-webkit-scrollbar { width: 4px; }
        #chat-messages::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }
        .chat-msg {
            margin-bottom: 6px;
            line-height: 1.4;
        }
        .chat-msg .chat-name {
            color: #3498db;
            font-weight: bold;
        }
        .chat-msg .chat-text {
            color: #eee;
        }
        .chat-msg .chat-time {
            color: #666;
            font-size: 11px;
            margin-left: 5px;
        }
        .chat-input-row {
            display: flex;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        #chat-input {
            flex: 1;
            padding: 10px 12px;
            border: none;
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 14px;
            outline: none;
        }
        #chat-input::placeholder {
            color: rgba(255,255,255,0.3);
        }
        .chat-send-btn {
            padding: 10px 15px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .chat-send-btn:hover {
            background: linear-gradient(135deg, #2980b9 0%, #2471a3 100%);
        }
        .chat-collapsed #chat-messages,
        .chat-collapsed .chat-input-row {
            display: none;
        }

        /* å¼€å§‹æ¸¸æˆæŒ‰é’® */
        .start-btn-container { margin-top: 15px; }
        .btn-start-game {
            padding: 12px 30px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            border: none;
            color: white;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
            transition: transform 0.2s;
        }
        .btn-start-game:hover { transform: scale(1.05); }
        .btn-start-game:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>â™  å¾·å·æ‰‘å…‹ â™¥</h1>
        <input type="text" id="nickname" placeholder="è¾“å…¥æ˜µç§°">
        <button class="btn-start" onclick="joinGame()">ğŸ° å…¥åº§</button>
    </div>

    <div id="game-screen" style="display:none;">
        
        <div class="info-board">
            <div class="stage-text">å½“å‰é˜¶æ®µ: <span id="stage-name" class="stage-name">ç­‰å¾…å¼€å§‹</span></div>
            <div class="pot-text">ğŸ’° åº•æ± : <span id="pot-num">0</span></div>
            <div id="community-cards"></div>
        </div>

        <div id="players-area"></div>

        <div id="logs"></div>

        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="chat-container" id="chat-container">
            <div class="chat-header" onclick="toggleChat()">
                <span>ğŸ’¬ èŠå¤©å®¤</span>
                <span class="chat-toggle" id="chat-toggle">æ”¶èµ· â–²</span>
            </div>
            <div id="chat-messages"></div>
            <div class="chat-input-row">
                <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="200" onkeypress="handleChatKeypress(event)">
                <button class="chat-send-btn" onclick="sendChatMsg()">å‘é€</button>
            </div>
        </div>

        <div class="start-btn-container">
            <button id="start-game-btn" class="btn-start-game" onclick="socket.emit('start_game')">ğŸ® å¼€å§‹æ¸¸æˆ</button>
        </div>

        <div id="controls-bar">
            <!-- å¿«æ·åŠ æ³¨æŒ‰é’® -->
            <div class="quick-raise-row">
                <button class="quick-btn" onclick="quickRaise('min')">æœ€å°åŠ æ³¨</button>
                <button class="quick-btn" onclick="quickRaise('half')">1/2 åº•æ± </button>
                <button class="quick-btn" onclick="quickRaise('pot')">åº•æ± </button>
                <button class="quick-btn allin" onclick="quickRaise('allin')">ALL IN</button>
            </div>
            
            <!-- åŠ æ³¨æ»‘å— -->
            <div class="raise-slider-row">
                <input type="range" id="raise-slider" class="raise-slider" min="0" max="1000" value="0" oninput="updateRaiseDisplay()">
                <div id="raise-amount-display" class="raise-amount-display">0</div>
            </div>
            
            <!-- ä¸»æ“ä½œæŒ‰é’® -->
            <div class="action-row">
                <button class="action-btn btn-fold" onclick="sendAction('fold')">å¼ƒç‰Œ</button>
                <button id="btn-call-check" class="action-btn btn-check" onclick="handleCallCheck()">è¿‡ç‰Œ</button>
                <button class="action-btn btn-raise" onclick="handleRaise()">åŠ æ³¨</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myId = null;
        let currentState = null; 
        let currentWinners = null;
        let myPlayer = null;

        // --- åŸºç¡€è¿æ¥é€»è¾‘ ---
        socket.on('connect', () => { myId = socket.id; });

        function joinGame() {
            const name = document.getElementById('nickname').value;
            if(!name) return alert("è¯·è¾“å…¥æ˜µç§°");
            socket.emit('join', name);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
        }

        // --- æ ¸å¿ƒï¼šUI æ¸²æŸ“ ---
        socket.on('update_state', (state) => {
            currentState = state;
            myPlayer = state.players.find(p => p.id === myId);
            
            if (state.stage === 'preflop' || state.stage === 'waiting') {
                currentWinners = null;
                document.getElementById('winner-overlay')?.remove();
            }

            // 1. æ›´æ–°é¡¶éƒ¨ä¿¡æ¯ - åŠ¨æ€è®¡ç®—åº•æ± ï¼ˆå·²å½’é›†çš„ + æœ¬è½®ä¸‹æ³¨ï¼‰
            const currentRoundBets = state.players.reduce((sum, p) => sum + p.bet, 0);
            const totalPot = state.pot + currentRoundBets;
            document.getElementById('pot-num').innerText = totalPot;
            document.getElementById('stage-name').innerText = translateStage(state.stage);
            
            const commDiv = document.getElementById('community-cards');
            commDiv.innerHTML = state.communityCards.map(c => renderCard(c)).join('');

            // 2. æ›´æ–°å¼€å§‹æŒ‰é’®çŠ¶æ€
            const startBtn = document.getElementById('start-game-btn');
            if (myPlayer && myPlayer.isHost) {
                startBtn.disabled = false;
                startBtn.innerText = 'ğŸ® å¼€å§‹æ¸¸æˆ';
            } else {
                startBtn.disabled = true;
                startBtn.innerText = 'ç­‰å¾…æˆ¿ä¸»å¼€å§‹';
            }
            if (state.stage !== 'waiting') {
                startBtn.style.display = 'none';
            } else {
                startBtn.style.display = 'inline-block';
            }

            // 3. æ¸²æŸ“æ‰€æœ‰ç©å®¶
            const pArea = document.getElementById('players-area');
            pArea.innerHTML = '';

            state.players.forEach((p, index) => {
                const isMe = p.id === myId;
                const isTurn = index === state.activeSeat;
                const isDealer = index === state.dealerSeat;

                let handHtml = '';
                if (p.hand && p.hand.length > 0) {
                    if (isMe || state.stage === 'showdown' || currentWinners) {
                        handHtml = p.hand.map(c => renderCard(c, true)).join('');
                    } else {
                        handHtml = '<span class="card" style="background:linear-gradient(135deg,#2c3e50,#34495e); color:#ccc;">ğŸ‚ </span><span class="card" style="background:linear-gradient(135deg,#2c3e50,#34495e); color:#ccc;">ğŸ‚ </span>';
                    }
                } else {
                    handHtml = '<span style="font-size:12px; color:#aaa;">ç­‰å¾…ä¸­</span>';
                }

                // çŠ¶æ€æ–‡æœ¬
                // ç¡®å®šç©å®¶æœ¬è½®æ“ä½œçŠ¶æ€
                let actionHtml = '';
                let betClass = p.bet > 0 ? 'has-bet' : '';
                
                if (p.folded) {
                    actionHtml = '<div class="p-action fold">âŒ å¼ƒç‰Œ</div>';
                } else if (p.lastAction === 'allin' || (p.chips === 0 && p.bet > 0)) {
                    actionHtml = '<div class="p-action allin">ğŸ”¥ ALL IN</div>';
                } else if (p.isWaiting) {
                    actionHtml = '<div class="p-action">â³ ç­‰å¾…ä¸‹ä¸€å±€</div>';
                } else if (p.lastAction && state.stage !== 'waiting') {
                    // æ ¹æ®æœåŠ¡å™¨è®°å½•çš„æ“ä½œç±»å‹æ˜¾ç¤º
                    switch(p.lastAction) {
                        case 'check':
                            actionHtml = '<div class="p-action check">âœ“ è¿‡ç‰Œ</div>';
                            break;
                        case 'call':
                            actionHtml = '<div class="p-action call">âœ“ è·Ÿæ³¨</div>';
                            break;
                        case 'raise':
                            actionHtml = '<div class="p-action raise">â†‘ åŠ æ³¨</div>';
                            break;
                    }
                }

                const playerHtml = `
                    <div class="player ${isTurn ? 'active-turn' : ''} ${p.folded ? 'folded' : ''} ${p.isHost ? 'is-host' : ''}">
                        ${isDealer ? '<div class="dealer-btn">D</div>' : ''}
                        <div class="p-name">${p.name}${isMe ? ' (æˆ‘)' : ''}</div>
                        <div class="p-chips">ğŸ’° ${p.chips}</div>
                        <div class="p-bet ${betClass}">æœ¬è½®ä¸‹æ³¨: ${p.bet}</div>
                        ${actionHtml}
                        <div style="margin-top:5px;">${handHtml}</div>
                    </div>
                `;
                pArea.innerHTML += playerHtml;

                if (isMe) {
                    const controls = document.getElementById('controls-bar');
                    if (isTurn && !p.folded) {
                        controls.style.display = 'flex';
                        updateButtonLogic(p, state.currentMaxBet);
                        updateSliderRange(p, state);
                    } else {
                        controls.style.display = 'none';
                    }
                }
            });

            if (currentWinners) {
                applyWinningEffects(currentWinners);
            }
        });

        // --- è¾…åŠ©é€»è¾‘ ---

        function renderCard(cardCode, isHand=false) {
            const suit = cardCode.slice(-1); 
            const rank = cardCode.slice(0, -1);
            const color = (suit === 'h' || suit === 'd') ? '#e74c3c' : '#2c3e50';
            const suitIcons = {'s':'â™ ', 'h':'â™¥', 'd':'â™¦', 'c':'â™£'};
            
            return `<span class="card" data-code="${cardCode}" style="color:${color}; ${isHand ? 'border:2px solid gold;' : ''}">
                ${rank}${suitIcons[suit]}
            </span>`;
        }

        function updateButtonLogic(me, maxBet) {
            const btn = document.getElementById('btn-call-check');
            const diff = maxBet - me.bet;

            if (diff > 0) {
                if (me.chips <= diff) {
                    btn.innerText = `All-in ${me.chips}`;
                    btn.className = "action-btn btn-call";
                    btn.dataset.action = "call";
                } else {
                    btn.innerText = `è·Ÿæ³¨ ${diff}`;
                    btn.className = "action-btn btn-call";
                    btn.dataset.action = "call"; 
                }
            } else {
                btn.innerText = "è¿‡ç‰Œ";
                btn.className = "action-btn btn-check";
                btn.dataset.action = "check";
            }
        }

        function updateSliderRange(me, state) {
            const slider = document.getElementById('raise-slider');
            const minRaise = state.minRaise || state.bigBlind || 20;
            const minValue = state.currentMaxBet + minRaise;
            const maxValue = me.chips + me.bet;
            
            slider.min = minValue;
            slider.max = maxValue;
            slider.value = minValue;
            updateRaiseDisplay();
        }

        function updateRaiseDisplay() {
            const slider = document.getElementById('raise-slider');
            const display = document.getElementById('raise-amount-display');
            display.innerText = slider.value;
        }

        // å¿«æ·åŠ æ³¨
        function quickRaise(type) {
            if (!myPlayer || !currentState) return;
            
            // è®¡ç®—å®é™…åº•æ± ï¼ˆå·²å½’é›†çš„ + æœ¬è½®æ‰€æœ‰ä¸‹æ³¨ï¼‰
            const currentRoundBets = currentState.players.reduce((sum, p) => sum + p.bet, 0);
            const totalPot = currentState.pot + currentRoundBets;
            
            const maxBet = currentState.currentMaxBet;
            const minRaise = currentState.minRaise || currentState.bigBlind || 20;
            const myBet = myPlayer.bet;
            const myChips = myPlayer.chips;
            
            let targetBet = 0;
            
            switch(type) {
                case 'min':
                    targetBet = maxBet + minRaise;
                    break;
                case 'half':
                    targetBet = maxBet + Math.floor(totalPot / 2);
                    break;
                case 'pot':
                    targetBet = maxBet + totalPot;
                    break;
                case 'allin':
                    targetBet = myBet + myChips;
                    break;
            }
            
            // ç¡®ä¿ä¸è¶…è¿‡ all-in
            targetBet = Math.min(targetBet, myBet + myChips);
            // ç¡®ä¿è‡³å°‘æ˜¯æœ€å°åŠ æ³¨
            targetBet = Math.max(targetBet, maxBet + minRaise);
            
            const slider = document.getElementById('raise-slider');
            slider.value = targetBet;
            updateRaiseDisplay();
            
            // å¦‚æœæ˜¯ all-inï¼Œç›´æ¥å‘é€
            if (type === 'allin') {
                socket.emit('action', { type: 'raise', amount: targetBet });
            }
        }

        // --- æŒ‰é’®ç‚¹å‡»äº‹ä»¶ ---

        function handleCallCheck() {
            const btn = document.getElementById('btn-call-check');
            const action = btn.dataset.action;
            socket.emit('action', { type: action });
        }

        function handleRaise() {
            const val = document.getElementById('raise-slider').value;
            if (!val) return;
            socket.emit('action', { type: 'raise', amount: parseInt(val) });
        }

        function sendAction(type) {
            socket.emit('action', { type: type });
        }

        // --- æ¶ˆæ¯ä¸ç¿»è¯‘ ---

        socket.on('system_msg', (msg) => {
            const logDiv = document.getElementById('logs');
            const time = new Date().toTimeString().split(' ')[0];
            logDiv.innerHTML = `<div><span style="color:#888">[${time}]</span> ${msg}</div>` + logDiv.innerHTML;
        });

        socket.on('game_over', (winners) => {
            showWinnerOverlay(winners.join('\n'), []);
        });

        socket.on('game_over_details', (winnerInfo) => {
            currentWinners = winnerInfo;
            
            const msgLines = winnerInfo.map(w => `ğŸ† ${w.name}<br><span style="font-size:14px;color:#aaa;">${w.desc || ''}</span>`);
            showWinnerOverlay(msgLines.join('<br><br>'), winnerInfo);
            
            applyWinningEffects(winnerInfo);
        });

        function showWinnerOverlay(msgHtml, winnerInfo) {
            if (document.getElementById('winner-overlay')) return;

            const div = document.createElement('div');
            div.id = 'winner-overlay';
            div.style.cssText = `
                position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%);
                background: linear-gradient(180deg, rgba(20,20,20,0.98) 0%, rgba(0,0,0,0.98) 100%);
                border: 3px solid #f1c40f; padding: 25px 40px;
                text-align: center; border-radius: 15px; z-index: 2000; min-width: 250px;
                box-shadow: 0 0 50px rgba(255, 215, 0, 0.4);
                animation: popin 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            `;
            div.innerHTML = `
                <h2 style="color:#f1c40f; margin:0 0 15px 0; font-size:24px;">ğŸ‰ ç»“ç®— ğŸ‰</h2>
                <div style="font-size:18px; line-height:1.6;">${msgHtml}</div>
                <div style="margin-top:20px; font-size:13px; color:#666;">ä¸‹ä¸€å±€å³å°†å¼€å§‹...</div>
            `;
            document.body.appendChild(div);

            const style = document.createElement('style');
            style.innerHTML = `@keyframes popin { from { transform: translate(-50%, -50%) scale(0.3); opacity:0;} to { transform: translate(-50%, -50%) scale(1); opacity:1;} }`;
            document.head.appendChild(style);
        }

        function applyWinningEffects(winnerInfo) {
            if (!winnerInfo) return;
            const allCards = Array.from(document.querySelectorAll('.card'));
            
            allCards.forEach(c => c.classList.remove('winning-card'));

            winnerInfo.forEach(w => {
                const winningCodes = w.cards || [];
                allCards.forEach(cardEl => {
                    const code = cardEl.dataset.code;
                    if (winningCodes.includes(code)) {
                        cardEl.classList.add('winning-card');
                    }
                });
            });
        }

        function translateStage(stage) {
            const map = {
                'waiting': 'ç­‰å¾…å¼€å§‹',
                'preflop': 'ç¿»ç‰Œå‰',
                'flop': 'ç¿»ç‰Œåœˆ',
                'turn': 'è½¬ç‰Œåœˆ',
                'river': 'æ²³ç‰Œåœˆ',
                'showdown': 'æ‘Šç‰Œ'
            };
            return map[stage] || stage;
        }

        // --- èŠå¤©åŠŸèƒ½ ---
        
        socket.on('chat_msg', (data) => {
            const chatDiv = document.getElementById('chat-messages');
            const msgHtml = `
                <div class="chat-msg">
                    <span class="chat-name">${data.name}:</span>
                    <span class="chat-text">${escapeHtml(data.msg)}</span>
                    <span class="chat-time">${data.time}</span>
                </div>
            `;
            chatDiv.innerHTML += msgHtml;
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            chatDiv.scrollTop = chatDiv.scrollHeight;
        });

        function sendChatMsg() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;
            
            socket.emit('chat_msg', msg);
            input.value = '';
        }

        function handleChatKeypress(e) {
            if (e.key === 'Enter') {
                sendChatMsg();
            }
        }

        function toggleChat() {
            const container = document.getElementById('chat-container');
            const toggle = document.getElementById('chat-toggle');
            
            if (container.classList.contains('chat-collapsed')) {
                container.classList.remove('chat-collapsed');
                toggle.innerText = 'æ”¶èµ· â–²';
            } else {
                container.classList.add('chat-collapsed');
                toggle.innerText = 'å±•å¼€ â–¼';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>